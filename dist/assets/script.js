var Utils=(()=>{var i={};return{throttle:function(e,t,a){var n=performance.now();return a<=n-(i[e]||0)&&(i[e]=n,t(),!0)},debounce:function(a,n){var i=null;return function(){var e=this,t=arguments;i&&clearTimeout(i),i=setTimeout(function(){a.apply(e,t),i=null},n)}},lerp:function(e,t,a){return e+(t-e)*a},distance:function(e,t,a,n){return a-=e,e=n-t,Math.sqrt(a*a+e*e)},distanceSquared:function(e,t,a,n){return(a-=e)*a+(e=n-t)*e},clamp:function(e,t,a){return Math.max(t,Math.min(a,e))},map:function(e,t,a,n,i){return n+(e-t)/(a-t)*(i-n)},randomRange:function(e,t){return e+Math.random()*(t-e)},randomInt:function(e,t){return Math.floor(e+Math.random()*(t-e+1))},normalizeAngle:function(e){return(e%=360)<0&&(e+=360),e},degToRad:function(e){return e*(Math.PI/180)},radToDeg:function(e){return e*(180/Math.PI)},smoothStep:function(e){return e*e*(3-2*e)},resetThrottles:function(){i={}}}})(),Pool=(()=>{var o={},r={enemy:{initialSize:50,maxSize:100,createElement:function(){var e=document.createElement("div");return e.className="enemy",e}},projectile:{initialSize:100,maxSize:200,createElement:function(){var e=document.createElement("div");return e.className="projectile",e}},impact:{initialSize:50,maxSize:100,createElement:function(){var e=document.createElement("div");return e.className="impact",e}},particle:{initialSize:100,maxSize:200,createElement:function(){var e=document.createElement("div");return e.className="death-particles",e}}};return{init:function(){for(var e in r)if(r.hasOwnProperty(e)){i=n=a=t=void 0;var t=e,a=r[e];o[t]={available:[],inUse:[],config:a,stats:{created:0,acquired:0,released:0,maxInUse:0}};for(var n=0;n<a.initialSize;n++){var i=a.createElement();i.dataset.poolType=t,i.style.display="none",o[t].available.push(i),o[t].stats.created++}}},acquire:function(e,t){var a,n=o[e];if(!n)return console.warn("Pool type not found:",e),null;0<n.available.length?a=n.available.pop():n.inUse.length<n.config.maxSize?((a=n.config.createElement()).dataset.poolType=e,n.stats.created++):(console.warn("Pool exhausted for type:",e),(a=n.config.createElement()).dataset.poolType=e,a.dataset.poolTemp="true");var i,r=a;for(i in r.style.cssText="",r.className=(e=>{switch(e){case"enemy":return"enemy";case"projectile":return"projectile";case"impact":return"impact";case"particle":return"death-particles";default:return""}})(e),t&&(r.className+=" "+t),"impact"!==e&&"particle"!==e||(r.innerHTML=""),r.dataset)"poolType"!==i&&"poolTemp"!==i&&delete r.dataset[i];return a.style.display="",n.inUse.push(a),n.stats.acquired++,n.stats.maxInUse=Math.max(n.stats.maxInUse,n.inUse.length),a},release:function(e){var t,a;e&&(t=e.dataset.poolType,!(t=o[t])||(-1<(a=t.inUse.indexOf(e))&&t.inUse.splice(a,1),e.style.display="none","true"===e.dataset.poolTemp)?e.parentNode&&e.parentNode.removeChild(e):(t.available.push(e),t.stats.released++))},getStats:function e(t){if(t)return(t=o[t])?{available:t.available.length,inUse:t.inUse.length,created:t.stats.created,acquired:t.stats.acquired,released:t.stats.released,maxInUse:t.stats.maxInUse}:null;var a,n={};for(a in o)o.hasOwnProperty(a)&&(n[a]=e(a));return n},clear:function(){for(var e in o)if(o.hasOwnProperty(e))for(var t=o[e];0<t.inUse.length;){var a=t.inUse.pop();a.style.display="none",t.available.push(a)}},destroy:function(){for(var e in o)o.hasOwnProperty(e)&&((e=o[e]).available.concat(e.inUse).forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)}),e.available=[],e.inUse=[])},prewarm:function(e,t){var a=o[e];if(a)for(var n=Math.min(t,a.config.maxSize-a.available.length-a.inUse.length),i=0;i<n;i++){var r=a.config.createElement();r.dataset.poolType=e,r.style.display="none",a.available.push(r),a.stats.created++}}}})();function Simple1DNoise(){for(var a=1,n=1,i=[],e=0;e<256;++e)i.push(Math.random());return{getVal:function(e){var e=e*n,t=Math.floor(e),e=e-t,e=e*e*(3-2*e),t=255&t;return(i[t]*(1-e)+i[1+t&255]*e)*a},setAmplitude:function(e){a=e},setScale:function(e){n=e}}}function Simple2DNoise(){for(var s=1,l=1,d=[],e=0;e<256;e++){d[e]=[];for(var t=0;t<256;t++)d[e][t]=Math.random()}function c(e,t,a){return e*(1-a)+t*a}function u(e){return e*e*(3-2*e)}return{getVal:function(e,t){var e=e*l,t=t*l,a=Math.floor(e),n=Math.floor(t),e=u(e-a),t=u(t-n),a=255&a,i=1+a&255,n=255&n,r=1+n&255,o=d[a][n],n=d[i][n],a=d[a][r],i=d[i][r],r=c(o,n,e),o=c(a,i,e);return 2*(c(r,o,t)-.5)*s},setAmplitude:function(e){s=e},setScale:function(e){l=e}}}var Noise=(()=>{var a=null,n=null,i=null;return{init:function(){(a=new Simple2DNoise).setAmplitude(15),a.setScale(.5),(n=new Simple2DNoise).setAmplitude(15),n.setScale(.5),(i=new Simple1DNoise).setAmplitude(.2),i.setScale(1)},getPathOffset:function(e,t){return a&&n?{x:a.getVal(.1*e,.01*t),y:n.getVal(.1*e+100,.01*t)}:{x:0,y:0}},getSpeedMultiplier:function(e,t){return i?1+i.getVal(e+.1*t):1},create1D:function(e,t){var a=new Simple1DNoise;return a.setAmplitude(e||1),a.setScale(t||1),a},create2D:function(e,t){var a=new Simple2DNoise;return a.setAmplitude(e||1),a.setScale(t||1),a}}})(),Effects=(()=>{var a={HIGH:"high",MEDIUM:"medium",LOW:"low"},n=a.HIGH,t=!1,i=!0,r=55,o=30,s=60,l=[],d=0,c=!1;function e(){(t=window.matchMedia?window.matchMedia("(prefers-reduced-motion: reduce)").matches:t)?(console.log("Reduced motion preference detected"),document.body.classList.add("prefers-reduced-motion")):document.body.classList.remove("prefers-reduced-motion")}function u(e){var t;c&&(t=e-d,d=e,0<t&&l.push(t),l.length>=s?(0!==l.length&&(e=1e3/(l.reduce(function(e,t){return e+t},0)/l.length),t=n,(n=r<=e?a.HIGH:o<=e?a.MEDIUM:a.LOW)!==t)&&(console.log("Performance level changed to: "+n+" (FPS: "+e.toFixed(1)+")"),m()),l=[],setTimeout(function(){c&&requestAnimationFrame(u)},5e3)):requestAnimationFrame(u))}function m(){var e=document.body,e=(e.classList.remove("performance-high","performance-medium","performance-low"),e.classList.add("performance-"+n),new CustomEvent("performanceLevelChanged",{detail:{level:n,effectsEnabled:i&&!t}}));document.dispatchEvent(e)}function h(){return i&&!t&&n!==a.LOW}function p(){return i&&!t&&n===a.HIGH}return{init:function(){e(),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",function(){e()}),setTimeout(function(){c||(c=!0,d=performance.now(),l=[],requestAnimationFrame(u))},2e3),m(),console.log("Effects Manager initialized")},setEffectsEnabled:function(e){(i=e)?document.body.classList.remove("effects-disabled"):document.body.classList.add("effects-disabled"),m()},setPerformanceLevel:function(e){a[e.toUpperCase()]&&(n=a[e.toUpperCase()],m())},getPerformanceLevel:function(){return n},stopMonitoring:function(){c=!1},shouldShowEffects:h,shouldShowComplexEffects:p,screenFlash:function(e){var t;h()&&((t=document.querySelector(".screen-flash"))||((t=document.createElement("div")).className="screen-flash",document.body.appendChild(t)),t.classList.remove("flash-damage","flash-gold","flash-heal"),t.offsetWidth,t.classList.add("flash-"+e),setTimeout(function(){t.classList.remove("flash-"+e)},300))},applyBurningEffect:function(e){h()&&e.classList.add("burning")},removeBurningEffect:function(e){e.classList.remove("burning")},triggerWarpEffect:function(){var e;p()&&((e=document.createElement("div")).className="starfield-warp",document.body.appendChild(e),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},600))},LEVELS:a}})(),Path=(()=>{var d=[{x:0,y:3},{x:2,y:3},{x:2,y:1},{x:5,y:1},{x:5,y:5},{x:8,y:5},{x:8,y:2},{x:10,y:2},{x:10,y:6},{x:11,y:6}],s=[],r=[];function i(e,t){return 0<=t&&t<8&&0<=e&&e<12?s[t][e]:null}function t(e,t){return{x:60*e+30-360,y:60*t+30-240,z:0}}return{init:function(){s=[],r=(()=>{for(var e=[],t=0;t<d.length-1;t++){var a=d[t],n=d[t+1];if(a.y===n.y)for(var i=Math.min(a.x,n.x),r=Math.max(a.x,n.x),o=i;o<=r;o++)e.push({x:o,y:a.y});else if(a.x===n.x)for(var i=Math.min(a.y,n.y),s=Math.max(a.y,n.y),l=i;l<=s;l++)e.push({x:a.x,y:l})}return e})();for(var e=0;e<8;e++){s[e]=[];for(var t=0;t<12;t++){var a=((e,t)=>{for(var a=0;a<r.length;a++)if(r[a].x===e&&r[a].y===t)return!0;return!1})(t,e),n=t===d[0].x&&e===d[0].y,i=t===d[d.length-1].x&&e===d[d.length-1].y;s[e][t]={x:t,y:e,type:a?"path":"grass",isStart:n,isEnd:i,buildable:!a,occupied:!1,tower:null}}}return s},render:function(){for(var e=document.getElementById("map"),t=e.querySelectorAll(".cell"),a=0;a<t.length;a++)t[a].parentNode.removeChild(t[a]);for(var n=0;n<8;n++)for(var i=0;i<12;i++){var r=s[n][i],o=document.createElement("div");o.className="cell",o.dataset.x=i,o.dataset.y=n,o.classList.add(r.type),r.isStart&&o.classList.add("start"),r.isEnd&&o.classList.add("end"),r.buildable&&!r.occupied&&o.classList.add("buildable"),r.occupied&&o.classList.add("occupied"),o.style.left=60*i+"px",o.style.top=60*n+"px",e.appendChild(o)}},getCell:i,gridToWorld:t,worldToGrid:function(e,t){return{x:Math.floor((e+360)/60),y:Math.floor((t+240)/60)}},getPathWaypoints:function(){return d.map(function(e){return t(e.x,e.y)})},occupyCell:function(e,t,a){var n=i(e,t);return!(!n||!n.buildable||(n.occupied=!0,n.tower=a,(n=document.querySelector('.cell[data-x="'+e+'"][data-y="'+t+'"]'))&&(n.classList.remove("buildable"),n.classList.add("occupied")),0))},freeCell:function(e,t){var a=i(e,t);return!!a&&(a.occupied=!1,a.tower=null,(e=document.querySelector('.cell[data-x="'+e+'"][data-y="'+t+'"]'))&&(e.classList.remove("occupied"),a.buildable)&&e.classList.add("buildable"),!0)},canBuild:function(e,t){return(e=i(e,t))&&e.buildable&&!e.occupied},getStartPosition:function(){return t(d[0].x,d[0].y)},getEndPosition:function(){var e=d[d.length-1];return t(e.x,e.y)},GRID_COLS:12,GRID_ROWS:8,CELL_SIZE:60}})(),Weather=(()=>{var r=["clear","rain","snow","wind"],o=10,s=20,t={towerRange:1.1,enemySpeed:1,gold:1},a={towerRange:.85,enemySpeed:1.1,gold:1.2},n={clear:{towerRange:1.05,enemySpeed:1,gold:1,tower:{}},rain:{towerRange:.9,enemySpeed:.95,gold:1,tower:{flame:{fireRate:.85},tesla:{chainRange:1.2}}},snow:{towerRange:.85,enemySpeed:.85,gold:1.1,tower:{flame:{damage:.9},ice:{slowDuration:1.2}}},wind:{towerRange:1,enemySpeed:1.05,gold:1,tower:{arrow:{range:1.2},cannon:{splashRadius:1.15},magic:{range:.9}}}},i=.8,l=1.15,d=1.5,v=!1,g="clear",c=0,f=!1,y=null,w=null,E=null,S=null,b=null;function x(e,t){v=e,y&&(e?(y.classList.add("night"),y.classList.remove("day")):(y.classList.add("day"),y.classList.remove("night"))),w&&(w.style.transform="rotate("+180*((t||1)-1)+"deg)")}function C(){c=o+Math.random()*(s-o);var e=null;if(e=void 0!==Seasons&&Seasons.getWeatherWeights?Seasons.getWeatherWeights():e){for(var t,a=Math.random(),n=0,i=0;i<r.length;i++)if(a<(n+=e[t=r[i]]||0))return void M(t);M("clear")}else Math.random()<.7?M("clear"):M(t=r[1+Math.floor(Math.random()*(r.length-1))])}function M(e){var t=g;if(t!==e){switch(g=e,E&&E.classList.add("hidden"),S&&S.classList.add("hidden"),b&&b.classList.add("hidden"),y&&y.classList.remove("weather-rain","weather-snow","weather-wind"),e){case"rain":E&&E.classList.remove("hidden"),y&&y.classList.add("weather-rain");break;case"snow":S&&S.classList.remove("hidden"),y&&y.classList.add("weather-snow");break;case"wind":b&&b.classList.remove("hidden"),y&&y.classList.add("weather-wind")}"function"==typeof emitGameEvent&&emitGameEvent("weatherChanged",{weather:e,previous:t})}}return{init:function(){if(y=document.getElementById("scene"),w=document.querySelector(".sky-body-container"),E=document.querySelector(".rain-container"),S=document.querySelector(".snow-container"),b=document.querySelector(".wind-container"),v=!1,f=!(g="clear"),M("clear"),x(!1),E){for(var e="",t=0;t<50;t++){var a=+Math.random(),n=.5+.3*Math.random(),i=100*Math.random();e+='<div class="rain-drop" style="left:'+i+"%; animation-delay:-"+a+"s; animation-duration:"+n+'s"></div>'}E.innerHTML=e}if(S){for(var r="",o=0;o<40;o++){var s=5*Math.random(),l=3+2*Math.random(),d=100*Math.random();r+='<div class="snow-flake" style="left:'+d+"%; animation-delay:-"+s+"s; animation-duration:"+l+'s"></div>'}S.innerHTML=r}if(b){for(var c="",u=0;u<15;u++){var m=2*Math.random(),h=+Math.random()+1,p=100*Math.random();c+='<div class="wind-line" style="top:'+p+"%; animation-delay:-"+m+"s; animation-duration:"+h+'s"></div>'}b.innerHTML=c}document.addEventListener("waveStarted",function(e){e=e.detail.wave;x(e%2==0,e),C()})},update:function(e){(c-=e)<=0&&C()},isNight:function(){return v},setBloodMoon:function(e){f=e},isBloodMoon:function(){return f},getRangeMultiplier:function(){var e=f?i:(v?a:t).towerRange;return e*n[g].towerRange},getEnemySpeedMultiplier:function(){var e=f?l:(v?a:t).enemySpeed;return e*n[g].enemySpeed},getGoldMultiplier:function(){var e=f?d:(v?a:t).gold;return e*n[g].gold},getTowerModifier:function(e,t){var a=n[g];return a.tower&&a.tower[e]&&a.tower[e][t]?a.tower[e][t]:1},getCurrentWeather:function(){return g}}})(),Seasons=(()=>{var a=["spring","summer","autumn","winter"],n=1,i={1:"summer",2:"summer",3:"autumn",4:"autumn",5:"winter",6:"winter",7:"spring",8:"spring",9:"summer",10:"summer"},o={spring:{name:"Spring",colors:{"--color-bg":"#B8D8E8","--color-grass":"#8BC34A","--color-grass-light":"#A8D965","--color-grass-dark":"#6B9A30","--color-path":"#E8C864","--color-path-light":"#F2DD8A","--color-path-dark":"#C4A642"},weatherWeights:{clear:.4,rain:.5,wind:.1,snow:0},sceneClass:null,gameplayModifiers:{enemySpeed:1.1,gold:1,waveReward:1,tower:{magic:{damage:1.15},tesla:{chainTargets:1}}}},summer:{name:"Summer",colors:{"--color-bg":"#7EC8D9","--color-grass":"#5EA65E","--color-grass-light":"#78C878","--color-grass-dark":"#3D7A3D","--color-path":"#F5A623","--color-path-light":"#FFD080","--color-path-dark":"#C4841A"},weatherWeights:{clear:.8,rain:.1,wind:.1,snow:0},sceneClass:null,gameplayModifiers:{enemySpeed:1,gold:1,waveReward:1,tower:{flame:{damage:1.15},ice:{slowDuration:.9}}}},autumn:{name:"Autumn",colors:{"--color-bg":"#E8B87A","--color-grass":"#D4884A","--color-grass-light":"#E8A868","--color-grass-dark":"#A66832","--color-path":"#8B6642","--color-path-light":"#A68060","--color-path-dark":"#6B4E32"},weatherWeights:{clear:.4,rain:.2,wind:.4,snow:0},sceneClass:null,gameplayModifiers:{enemySpeed:1,gold:1.15,waveReward:1.2,tower:{arrow:{range:1.1}}}},winter:{name:"Winter",colors:{"--color-bg":"#D4E4EC","--color-grass":"#E8E0D8","--color-grass-light":"#F2ECE8","--color-grass-dark":"#C8BEB4","--color-path":"#A0AAB4","--color-path-light":"#B8C4D0","--color-path-dark":"#889098"},weatherWeights:{clear:.3,rain:0,wind:.2,snow:.5},sceneClass:"aurora-active",gameplayModifiers:{enemySpeed:.9,gold:1,waveReward:1,tower:{ice:{slowDuration:1.25,slowAmount:1.1},flame:{damage:.85}}}}};function r(e){var t=o[e];if(t){var a,n=document.documentElement;for(a in t.colors)t.colors.hasOwnProperty(a)&&n.style.setProperty(a,t.colors[a]);var i,r=document.querySelector(".scene");r&&(r.classList.remove("aurora-active"),t.sceneClass)&&(r.classList.add(t.sceneClass),"aurora-active"===t.sceneClass)&&((r=r).querySelector(".aurora-sky")||((i=document.createElement("div")).className="aurora-sky",r.insertBefore(i,r.firstChild)),r.querySelector(".aurora-particles")||((i=document.createElement("div")).className="aurora-particles",r.insertBefore(i,r.firstChild))),"function"==typeof emitGameEvent&&emitGameEvent("seasonChanged",{season:e,name:t.name})}}function s(){return a[n]}function l(){return o[a[n]].name}return{init:function(){r(a[n=1]),document.addEventListener("waveStarted",function(e){var t,e=e.detail.wave,e=i[e];e&&e!==s()&&-1!==(t=a.indexOf(e))&&(n=t,r(e),void 0!==Display)&&Display.showMessage("Season Changed: "+l().toUpperCase())})},getCurrentSeason:s,getSeasonName:l,getWeatherWeights:function(){return o[a[n]].weatherWeights},getEnemySpeedMultiplier:function(){return o[s()].gameplayModifiers.enemySpeed},getGoldMultiplier:function(){return o[s()].gameplayModifiers.gold},getWaveRewardMultiplier:function(){return o[s()].gameplayModifiers.waveReward},getTowerModifier:function(e,t){var a=o[s()].gameplayModifiers.tower;return a&&a[e]&&void 0!==a[e][t]?a[e][t]:1},getTeslaChainBonus:function(){var e=o[s()];return e.gameplayModifiers.tower&&e.gameplayModifiers.tower.tesla&&e.gameplayModifiers.tower.tesla.chainTargets?e.gameplayModifiers.tower.tesla.chainTargets:0}}})(),Auth=(()=>{var i=null,n="/api",o=null;function s(){return fetch(n+"/auth/get-session",{credentials:"include"}).then(function(e){return e.ok?e.json():null}).then(function(e){return i=e&&e.user?e.user:null,h(),emitGameEvent("authStateChanged",{user:i}),i}).catch(function(){i=null,h()})}function l(e,t){return fetch(n+"/auth/sign-in/email",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}).then(function(e){return e.ok?e.json():e.json().then(function(e){throw new Error(e.message||"Sign in failed")})}).then(function(e){return i=e.user||null,h(),m(),emitGameEvent("authStateChanged",{user:i}),i&&r(),i})}function d(e,t,a){return fetch(n+"/auth/sign-up/email",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:a})}).then(function(e){return e.ok?e.json():e.json().then(function(e){throw new Error(e.message||"Sign up failed")})}).then(function(e){return i=e.user||null,h(),m(),emitGameEvent("authStateChanged",{user:i}),i&&r(),i})}function c(){return fetch(n+"/auth/sign-out",{method:"POST",credentials:"include"}).then(function(){i=null,h(),emitGameEvent("authStateChanged",{user:i})}).catch(function(){i=null,h()})}function r(){var e=parseInt(localStorage.getItem("towerDefenseHighScore"))||0,t=[];try{var a=localStorage.getItem("td_achievements");a&&(t=JSON.parse(a))}catch(e){}a={xp:0,level:1,skillPoints:0,upgrades:{}};try{var n,i=localStorage.getItem("td_progression");i&&(n=JSON.parse(i),a.xp=n.xp||0,a.level=n.level||1,a.skillPoints=n.skillPoints||0,a.upgrades=n.upgrades||{})}catch(e){}(0<e||0<t.length||1<a.level)&&void 0!==API&&API.syncProgression&&(API.syncProgression({xp:a.xp,level:a.level,skillPoints:a.skillPoints,upgrades:a.upgrades,highScore:e,achievements:t}),0<t.length)&&API.unlockAchievement&&t.forEach(function(e){API.unlockAchievement(e)})}function u(e){var t,a,n,i,r;o&&(t=document.getElementById("authModalTitle"),a=document.getElementById("authNameField"),n=document.getElementById("authSubmit"),i=document.getElementById("authSwitchText"),r=document.getElementById("authSwitchLink"),document.getElementById("authError").classList.add("hidden"),e?(t.textContent="Sign Up",a.classList.remove("hidden"),n.textContent="Sign Up",i.textContent="Already have an account?",r.textContent="Sign In"):(t.textContent="Sign In",a.classList.add("hidden"),n.textContent="Sign In",i.textContent="No account?",r.textContent="Sign Up"),o.classList.remove("hidden"))}function m(){o&&o.classList.add("hidden")}function h(){var e=document.getElementById("authBtn"),t=document.getElementById("authOutBtn"),a=document.getElementById("authUser"),n=document.getElementById("saveLoadBtn");i?(e&&e.classList.add("hidden"),a&&(a.textContent=i.name,a.classList.remove("hidden")),t&&t.classList.remove("hidden"),n&&n.classList.remove("hidden")):(e&&e.classList.remove("hidden"),a&&a.classList.add("hidden"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden"))}return{init:function(){var e,t,a,n,i,r;return(r=document.getElementById("loadingScreen"))&&((e=document.createElement("div")).className="auth-container",e.id="authContainer",e.innerHTML='<button class="auth-btn" id="authBtn">Sign In</button><span class="auth-user hidden" id="authUser"></span><button class="auth-btn auth-btn-small hidden" id="authOutBtn">Sign Out</button>',r.appendChild(e),(o=document.createElement("div")).className="auth-modal hidden",o.id="authModal",o.innerHTML='<div class="auth-modal-content"><h2 class="auth-modal-title" id="authModalTitle">Sign In</h2><div class="auth-error hidden" id="authError"></div><form class="auth-form" id="authForm"><div class="auth-field hidden" id="authNameField"><label for="authName">Display Name</label><input type="text" id="authName" placeholder="Your name" maxlength="30" autocomplete="name"></div><div class="auth-field"><label for="authEmail">Email</label><input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email" required></div><div class="auth-field"><label for="authPassword">Password</label><input type="password" id="authPassword" placeholder="Password" minlength="8" autocomplete="current-password" required></div><button type="submit" class="auth-submit" id="authSubmit">Sign In</button></form><div class="auth-switch"><span id="authSwitchText">No account?</span> <a href="#" id="authSwitchLink">Sign Up</a></div><button class="auth-close" id="authClose">&times;</button></div>',document.body.appendChild(o),r=document.getElementById("authBtn"),e=document.getElementById("authOutBtn"),t=document.getElementById("authClose"),a=document.getElementById("authForm"),n=document.getElementById("authSwitchLink"),i=!1,r&&r.addEventListener("click",function(e){e.stopPropagation(),u(!1)}),e&&e.addEventListener("click",function(e){e.stopPropagation(),c()}),t&&t.addEventListener("click",function(e){e.stopPropagation(),m()}),n&&n.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),u(i=!i)}),a)&&a.addEventListener("submit",function(e){e.preventDefault(),e.stopPropagation();var e=document.getElementById("authEmail").value,t=document.getElementById("authPassword").value,a=document.getElementById("authError"),n=(a.classList.add("hidden"),a.textContent="",document.getElementById("authSubmit"));n.disabled=!0,n.textContent="Loading...",(i?d(document.getElementById("authName").value||"Player",e,t):l(e,t)).then(function(){n.disabled=!1,n.textContent=i?"Sign Up":"Sign In"}).catch(function(e){a.textContent=e.message||"Something went wrong",a.classList.remove("hidden"),n.disabled=!1,n.textContent=i?"Sign Up":"Sign In"})}),s()},signIn:l,signUp:d,signOut:c,isLoggedIn:function(){return!!i},getUser:function(){return i},checkSession:s}})(),API=(()=>{var a="/api";function n(e,t){return(t=t||{}).credentials="include",t.headers=t.headers||{},!t.body||"object"!=typeof t.body||t.body instanceof FormData||(t.headers["Content-Type"]="application/json",t.body=JSON.stringify(t.body)),fetch(a+e,t).then(function(t){return t.ok?t.json():t.json().then(function(e){throw new Error(e.error||"Request failed")}).catch(function(e){if(e.message)throw e;throw new Error("Request failed: "+t.status)})})}function i(e,t){return Auth.isLoggedIn()?n(e,t).catch(function(){return null}):Promise.resolve(null)}return{getLeaderboard:function(e,t,a){return n("/leaderboard"+("?difficulty="+(e||"normal")+"&limit="+(t||50)+"&offset="+(a||0)))},getMyRank:function(e){return i("/leaderboard/me?difficulty="+(e||"normal"))},submitScore:function(e){return i("/leaderboard",{method:"POST",body:e})},getSaves:function(){return i("/saves")},saveGame:function(e,t){return i("/saves/"+e,{method:"PUT",body:t})},deleteSave:function(e){return i("/saves/"+e,{method:"DELETE"})},getProgression:function(){return i("/progression")},saveProgression:function(e){return i("/progression",{method:"PUT",body:e})},syncProgression:function(e){return i("/progression/sync",{method:"POST",body:{localData:e}})},recordGame:function(e){return i("/stats/game",{method:"POST",body:e})},getMyStats:function(){return i("/stats/me")},unlockAchievement:function(e){return i("/stats/achievements",{method:"POST",body:{achievementId:e}})},getAchievements:function(){return i("/stats/achievements")},getGlobalAchievements:function(){return n("/stats/achievements/global")},getPlayerProfile:function(e){return n("/stats/player/"+e)},getDailyChallenge:function(){return n("/challenges/today")},completeDailyChallenge:function(e){return i("/challenges/complete",{method:"POST",body:e})},getChallengeLeaderboard:function(e){return n("/challenges/leaderboard?date="+(e||""))},getMyChallenges:function(){return i("/challenges/me")}}})(),Challenge=(()=>{var a={speed_run:{name:"Speed Run",description:"Complete in under 15 minutes",constraint:"time_limit"},arrow_only:{name:"Archer's Path",description:"Arrow towers only",allowedTowers:["arrow"],scoreBonus:1.5},no_sell:{name:"No Refunds",description:"Cannot sell towers",scoreBonus:1.25},budget:{name:"Penny Pincher",description:"Start with only 50 gold",startGold:50,scoreBonus:2},fragile:{name:"Glass Cannon",description:"Only 5 starting lives",startLives:5},boss_rush:{name:"Boss Rush",description:"Start at wave 8 with 500 gold",startWave:8,startGold:500,scoreBonus:2},ice_age:{name:"Ice Age",description:"Arrow and Ice towers only",allowedTowers:["arrow","ice"],scoreBonus:1.75},material_hunter:{name:"Scavenger",description:"Score based on materials collected"},combo_master:{name:"Combo Frenzy",description:"Bonus for combos of 5+"},tower_limit:{name:"Minimalist",description:"Maximum 6 towers",maxTowers:6,scoreBonus:2.5}},n=!1,i=null,r=null,o={};return{startChallenge:function(e){var t=a[e];return!!t&&(n=!0,r=e,i=t,o={comboSum:0,materialsCollected:0},(e=document.getElementById("challengeBanner"))&&e.parentNode.removeChild(e),n&&i&&((e=document.createElement("div")).className="challenge-banner",e.id="challengeBanner",e.textContent="Challenge: "+i.name,document.body.appendChild(e)),!0)},isActive:function(){return n},getTemplate:function(){return i},getTemplateId:function(){return r},getTrackingData:function(){return o},isTowerAllowed:function(e){return!n||!i||!i.allowedTowers||-1!==i.allowedTowers.indexOf(e)},isSellAllowed:function(){return!n||!i||"no_sell"!==r},getMaxTowers:function(){return n&&i&&i.maxTowers||1/0},getStartModifiers:function(){var e;return n&&i?(e={},void 0!==i.startGold&&(e.gold=i.startGold),void 0!==i.startLives&&(e.lives=i.startLives),void 0!==i.startWave&&(e.startWave=i.startWave),e):{}},getScoreBonus:function(){return n&&i&&i.scoreBonus||1},end:function(){var e;n=!1,r=i=null,o={},(e=document.getElementById("challengeBanner"))&&e.parentNode.removeChild(e)},TEMPLATES:a}})(),Progression=(()=>{var r=0,d=1,c=0,t=100,a=1.5,n="td_progression",e=null,i=5e3,u={cheaper_towers:{name:"Budget Engineering",description:"Towers cost 10% less",maxLevel:3,currentLevel:0,cost:1},start_gold:{name:"Trust Fund",description:"+50 Starting Gold",maxLevel:3,currentLevel:0,cost:1},damage_boost:{name:"Heavy Rounds",description:"+10% Tower Damage",maxLevel:3,currentLevel:0,cost:2},attack_speed:{name:"Rapid Fire",description:"+10% Attack Speed",maxLevel:3,currentLevel:0,cost:2},range_boost:{name:"Eagle Eye",description:"+10% Tower Range",maxLevel:3,currentLevel:0,cost:1},crit_chance:{name:"Lucky Shot",description:"+5% Crit Chance",maxLevel:3,currentLevel:0,cost:2},gold_bonus:{name:"Greed",description:"+15% Gold from kills",maxLevel:3,currentLevel:0,cost:2},slow_boost:{name:"Deep Freeze",description:"+20% Slow Duration",maxLevel:2,currentLevel:0,cost:2},splash_boost:{name:"Blast Radius",description:"+20% Splash Range",maxLevel:2,currentLevel:0,cost:2},extra_lives:{name:"Reinforcements",description:"+5 Starting Lives",maxLevel:2,currentLevel:0,cost:3}},o=null,s=null,l=null,m=null;function h(){o&&(o.classList.toggle("hidden"),o.classList.contains("hidden")||C())}function p(e){r+=e;for(var t=v(d);t<=r;)r-=t,d++,c++,Display.showMessage("LEVEL UP! Level "+d),t=v(d);x(),w(),b()}function v(e){return Math.floor(t*Math.pow(a,e-1))}function g(e){e=u[e];return!!e&&c>=e.cost&&e.currentLevel<e.maxLevel&&(c-=e.cost,e.currentLevel++,x(),w(),b(),!0)}function f(){var e,t={};for(e in u)t[e]=u[e].currentLevel;return t}function y(e){if(e)for(var t in e)u[t]&&"number"==typeof e[t]&&(u[t].currentLevel=Math.min(e[t],u[t].maxLevel))}function w(){try{var e={xp:r,level:d,skillPoints:c,upgrades:f()};localStorage.setItem(n,JSON.stringify(e))}catch(e){}}function E(){void 0!==API&&void 0!==Auth&&Auth.isLoggedIn()&&API.saveProgression({xp:r,level:d,skillPoints:c,upgrades:f()})}function S(){void 0!==API&&void 0!==Auth&&Auth.isLoggedIn()&&API.getProgression().then(function(e){if(e){if((e.level>d||e.level===d&&(e.xp||0)>r)&&(r=e.xp||0,d=e.level||1,c=e.skillPoints||0),e.upgrades){var t,a,n,i=f();for(t in e.upgrades)u[t]&&(a=e.upgrades[t]||0,n=i[t]||0,u[t].currentLevel=Math.min(Math.max(a,n),u[t].maxLevel))}w(),E(),C()}})}function b(){e&&clearTimeout(e),e=setTimeout(function(){E(),e=null},i)}function x(){var e=document.getElementById("playerLevel"),t=document.getElementById("skillPoints");e&&(e.textContent=d),t&&(t.textContent=c),C()}function C(){if(m){m.innerHTML="";for(var e=Object.keys(u),t=0;t<e.length;t++){var a=e[t],n=u[a],i=document.createElement("div"),r=(i.className="tech-card",i.dataset.upgradeId=a,n.currentLevel>=n.maxLevel),o=c>=n.cost,o=(r?i.classList.add("maxed"):o||i.classList.add("unavailable"),n.currentLevel+"/"+n.maxLevel);i.innerHTML="<h3>"+n.name+"</h3><p>"+n.description+'</p><p class="tech-level">Level: '+o+'</p><p class="tech-cost">'+(r?"MAXED":"Cost: "+n.cost+" SP")+"</p>",r||(e=>{i.addEventListener("click",function(){g(e)?(void 0!==Sfx&&Sfx.play("upgrade"),void 0!==Display&&Display.showMessage("Upgraded "+u[e].name+"!")):(void 0!==Sfx&&Sfx.play("error"),void 0!==Display&&Display.showMessage("Not enough SP!"))})})(a),m.appendChild(i)}var s=document.getElementById("playerLevel"),l=document.getElementById("skillPoints");s&&(s.textContent=d),l&&(l.textContent=c)}}return{init:function(){o=document.getElementById("techModal"),s=document.getElementById("techBtn"),l=document.getElementById("closeTechBtn"),m=document.getElementById("techGrid"),s&&s.addEventListener("click",h),l&&l.addEventListener("click",h);try{var e,t=localStorage.getItem(n);t&&(e=JSON.parse(t),r=e.xp||0,d=e.level||1,c=e.skillPoints||0,y(e.upgrades))}catch(e){}document.addEventListener("enemyKilled",function(e){p(2*e.detail.reward)}),document.addEventListener("waveComplete",function(e){p(e.detail.reward)}),document.addEventListener("authStateChanged",function(e){e.detail&&e.detail.user&&S()}),C()},upgrade:g,getTowerCostMultiplier:function(){return 1-.1*u.cheaper_towers.currentLevel},getStartingGoldBonus:function(){return 50*u.start_gold.currentLevel},getDamageMultiplier:function(){return 1+.1*u.damage_boost.currentLevel},getAttackSpeedMultiplier:function(){return 1+.1*u.attack_speed.currentLevel},getRangeMultiplier:function(){return 1+.1*u.range_boost.currentLevel},getCritChance:function(){return.05*u.crit_chance.currentLevel},getGoldMultiplier:function(){return 1+.15*u.gold_bonus.currentLevel},getSlowDurationMultiplier:function(){return 1+.2*u.slow_boost.currentLevel},getSplashRadiusMultiplier:function(){return 1+.2*u.splash_boost.currentLevel},getExtraLives:function(){return 5*u.extra_lives.currentLevel},getLevel:function(){return d},getXP:function(){return r},getSkillPoints:function(){return c},getUpgrades:function(){return u},getUpgradeState:f,applyUpgradeState:y,loadFromServer:S,saveToServer:E}})(),Inventory=(()=>{var c={scrap:{name:"Scrap Metal",rarity:"common",color:"#888888"},core:{name:"Power Core",rarity:"rare",color:"#0088FF"},crystal:{name:"Magic Crystal",rarity:"epic",color:"#AA00FF"}},u={slime:{scrap:.1,core:.01,crystal:0},goblin:{scrap:.15,core:.03,crystal:0},knight:{scrap:.2,core:.05,crystal:.01},boss:{scrap:1,core:1,crystal:1}},m={elite:{scrap:1.5,core:2,crystal:1.5},armored:{scrap:1.3,core:1.5,crystal:1.2},speedy:{scrap:1.2,core:1.2,crystal:1},toxic:{scrap:1.4,core:1.8,crystal:1.3}},n={scrap:0,core:0,crystal:0},h=1;function p(e,t){n.hasOwnProperty(e)&&(n[e]+=t,a())}function e(){return Object.assign({},n)}function a(){var e=document.getElementById("invScrap"),t=document.getElementById("invCore"),a=document.getElementById("invCrystal");e&&(e.textContent=n.scrap),t&&(t.textContent=n.core),a&&(a.textContent=n.crystal)}return{init:function(){n={scrap:0,core:0,crystal:0},h=1,document.addEventListener("enemyKilled",function(e){var t,a,i,r,n=e.detail.enemy,o=u[n.type]||u.slime,s=n.variant?m[n.variant]:null,l=[];for(t in o){var d=o[t];s&&(d*=s[t]||1),d*=h,Math.random()<d&&(d="boss"===n.type?Math.floor(3*Math.random())+2:1,p(t,d),l.push({type:t,qty:d}))}0<l.length&&(e=Path.GRID_COLS*Path.CELL_SIZE,a=Path.GRID_ROWS*Path.CELL_SIZE,i=n.x+e/2,r=n.y+a/2,l.forEach(function(e,t){var a=c[e.type],n=document.createElement("div"),e=(n.className="loot-drop loot-"+a.rarity,n.textContent="+"+e.qty+" "+a.name,n.style.cssText="position: absolute; left: "+i+"px; top: "+(r-20-25*t)+"px; color: "+a.color+'; font-family: "Bangers", cursive; font-size: 1rem; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 1000; animation: loot-float 1.5s ease-out forwards;',document.getElementById("map"));e&&e.appendChild(n),setTimeout(function(){n.parentNode&&n.parentNode.removeChild(n)},1500)}))}),a()},addMaterial:p,removeMaterial:function(e,t){return!!(n.hasOwnProperty(e)&&n[e]>=t)&&(n[e]-=t,a(),!0)},hasMaterials:function(e){for(var t in e)if(!n.hasOwnProperty(t)||n[t]<e[t])return!1;return!0},getInventory:e,getState:e,setDropMultiplier:function(e){h=e},MATERIALS:c}})(),Crafting=(()=>{var n={iron_skin:{name:"Iron Skin",description:"+3 lives (permanent)",cost:{scrap:5},type:"instant",effect:function(){void 0!==Game&&Game.addLives&&(Game.addLives(3),Display.showMessage("+3 Lives!"))}},overcharge:{name:"Overcharge",description:"+25% tower damage (1 wave)",cost:{core:3},type:"wave_buff",buff:{damage_mult:1.25}},frost_trap:{name:"Frost Trap",description:"Enemies 30% slower (1 wave)",cost:{scrap:2,core:1},type:"wave_buff",buff:{slow_enemies:.7}},gold_magnet:{name:"Gold Magnet",description:"+50% gold (1 wave)",cost:{scrap:3,core:2},type:"wave_buff",buff:{gold_mult:1.5}},crystal_shield:{name:"Crystal Shield",description:"Block next 3 hits",cost:{crystal:1,scrap:2},type:"shield",charges:3},arcane_barrage:{name:"Arcane Barrage",description:"+50% attack speed (1 wave)",cost:{crystal:2,core:1},type:"wave_buff",buff:{attack_speed_mult:1.5}}},i=[],r=0;function e(){for(var e=i.length-1;0<=e;e--)i[e].wavesRemaining--,i[e].wavesRemaining<=0&&i.splice(e,1)}return{init:function(){i=[],r=0,document.addEventListener("waveComplete",function(){e()})},craft:function(e){var t,a=n[e];if(!a)return!1;if(void 0===Inventory||!Inventory.hasMaterials(a.cost))return void 0!==Display&&Display.showMessage("Not enough materials!"),void 0!==Sfx&&Sfx.play("error"),!1;for(t in a.cost)Inventory.removeMaterial(t,a.cost[t]);return"instant"===a.type?a.effect():"wave_buff"===a.type?i.push({id:e,name:a.name,buff:a.buff,wavesRemaining:1}):"shield"===a.type&&(r+=a.charges),void 0!==Display&&Display.showMessage("Crafted "+a.name+"!"),void 0!==Sfx&&Sfx.play("powerup"),!0},getMultiplier:function(e){for(var t=1,a=0;a<i.length;a++)i[a].buff&&i[a].buff[e]&&(t*=i[a].buff[e]);return t},absorbDamage:function(e){return r<=0?e:(--r<=0&&void 0!==Display&&Display.showMessage("Shield depleted!"),0)},onWaveComplete:e,getActiveBuffs:function(){return i.slice()},getShieldCharges:function(){return r},isActive:function(){return 0<i.length||0<r},RECIPES:n}})(),Enemy=(()=>{var d={slime:{name:"Slime",health:50,speed:40,reward:10,damage:1,className:"enemy-slime"},goblin:{name:"Goblin",health:80,speed:60,reward:15,damage:1,className:"enemy-goblin"},knight:{name:"Knight",health:200,speed:30,reward:25,damage:2,armor:5,className:"enemy-knight"},boss:{name:"Boss",health:1e3,speed:20,reward:100,damage:5,armor:10,className:"enemy-boss",skills:{summon:{cooldown:1e4,count:3},shield:{cooldown:15e3,armor:50,duration:5e3},enrage:{healthThreshold:.3,speedBoost:.5,damageMultiplier:2}}}},c={elite:{name:"Elite",healthMultiplier:2,speedMultiplier:1.3,rewardMultiplier:2.5,damageMultiplier:1.5,className:"elite"},armored:{name:"Armored",healthMultiplier:1.5,speedMultiplier:.8,rewardMultiplier:1.8,armorBonus:10,className:"armored"},speedy:{name:"Speedy",healthMultiplier:.7,speedMultiplier:2,rewardMultiplier:1.5,className:"speedy"},toxic:{name:"Toxic",healthMultiplier:1.2,speedMultiplier:1,rewardMultiplier:2,damageMultiplier:2,className:"toxic"}},i=[],u=0,m=null;function a(e,t,a){var n=d[e],i=a?c[a]:null,r=(this.id=++u,this.type=e,this.variant=a||null,this.config=n,i?i.healthMultiplier:1),o=i?i.speedMultiplier:1,s=i?i.rewardMultiplier:1,l=i&&i.damageMultiplier||1,i=i&&i.armorBonus||0,r=(this.health=Math.round(n.health*r),this.maxHealth=this.health,this.speed=n.speed*o,this.baseSpeed=this.speed,this.reward=Math.round(n.reward*s),this.damage=Math.round(n.damage*l),this.armor=(n.armor||0)+i,this.path=t,this.pathIndex=0,t[this.distanceTraveled=0]);this.x=r.x,this.y=r.y,this.z=0,this.alive=!0,this.reachedEnd=!1,this.slowed=!1,this.slowTimer=0,this.useNoiseMovement="boss"===e||"speedy"===a,this.noiseTime=1e3*Math.random(),"boss"===e?(this.isBoss=!0,this.bossPhase=1,this.summonCooldown=0,this.shieldCooldown=0,this.shieldActive=!1,this.shieldTimer=0,this.baseArmor=this.armor,this.enraged=!1):this.isBoss=!1,this.element=this.createElement(),m.appendChild(this.element),this.render()}return a.prototype.getClassName=function(){var e=this.variant?c[this.variant].className:"";return"enemy "+this.config.className+(e?" "+e:"")},a.prototype.createElement=function(){var e=document.createElement("div"),t=this.variant?c[this.variant].className:"";switch(e.className="enemy "+this.config.className+(t?" "+t:""),e.dataset.id=this.id,this.type){case"slime":this.createSlimeElements(e);break;case"goblin":this.createGoblinElements(e);break;case"knight":this.createKnightElements(e);break;case"boss":this.createBossElements(e);break;default:this.createDefaultElements(e)}var t=document.createElement("div"),a=(t.className="health-bar",document.createElement("div"));return a.className="health-fill",a.style.width="100%",t.appendChild(a),e.appendChild(t),e},a.prototype.createSlimeElements=function(e){var t=document.createElement("div"),t=(t.className="enemy-body",e.appendChild(t),document.createElement("div")),a=(t.className="enemy-face",e.appendChild(t),document.createElement("div"));a.className="tentacles";for(var n=1;n<=4;n++){var i=document.createElement("div");i.className="tentacle t"+n,a.appendChild(i)}e.appendChild(a)},a.prototype.createGoblinElements=function(e){var t=document.createElement("div"),t=(t.className="enemy-body",e.appendChild(t),document.createElement("div")),t=(t.className="enemy-face",e.appendChild(t),document.createElement("div")),t=(t.className="enemy-eyes",e.appendChild(t),document.createElement("div")),a=(t.className="arms",document.createElement("div")),a=(a.className="arm left",t.appendChild(a),document.createElement("div"));a.className="arm right",t.appendChild(a),e.appendChild(t)},a.prototype.createKnightElements=function(e){var t=document.createElement("div"),a=(t.className="cape",document.createElement("div")),a=(a.className="cape-main",t.appendChild(a),e.appendChild(t),document.createElement("div")),t=(a.className="enemy-body",e.appendChild(a),document.createElement("div")),a=(t.className="enemy-face",e.appendChild(t),document.createElement("div"));a.className="sword",e.appendChild(a)},a.prototype.createBossElements=function(e){var t=document.createElement("div");t.className="energy-rings";for(var a=1;a<=3;a++){var n=document.createElement("div"),i=(n.className="ring-container ring-"+a,document.createElement("div"));i.className="ring",n.appendChild(i),a<=2&&(1===a?["1","2"]:["3","4"]).forEach(function(e){var t=document.createElement("div");t.className="orb orb-"+e,n.appendChild(t)}),t.appendChild(n)}e.appendChild(t);var r=document.createElement("div"),r=(r.className="enemy-body",e.appendChild(r),document.createElement("div")),r=(r.className="enemy-face",e.appendChild(r),document.createElement("div")),r=(r.className="enemy-eyes",e.appendChild(r),document.createElement("div")),o=(r.className="spikes",document.createElement("div")),o=(o.className="spike left",r.appendChild(o),document.createElement("div"));o.className="spike right",r.appendChild(o),e.appendChild(r)},a.prototype.createDefaultElements=function(e){var t=document.createElement("div"),t=(t.className="enemy-body",e.appendChild(t),document.createElement("div"));t.className="enemy-face",e.appendChild(t)},a.prototype.update=function(e){if(this.alive&&!this.reachedEnd){if(this.isBoss&&this.updateBoss(e),this.slowed&&(this.slowTimer-=e,this.slowTimer<=0)&&(this.slowed=!1,this.speed=this.baseSpeed,this.element.classList.remove("slowed")),this.burning){if(this.burnTimer+=e,this.burnTimer>=this.burnInterval){this.burnTimer-=this.burnInterval,this.health-=this.burnDamage;var t=Math.max(0,this.health/this.maxHealth*100),a=this.element.querySelector(".health-fill");if(a&&(a.style.width=t+"%"),this.health<=0)return void this.die()}this.burnDuration-=e,this.burnDuration<=0&&(this.burning=!1,this.element.classList.remove("burning"))}var n,i,r,o,a=this.path[this.pathIndex];a?(t=a.x-this.x,n=a.y-this.y,i=Math.sqrt(t*t+n*n),r=this.speed*e,o=1,void 0!==Weather&&Weather.getEnemySpeedMultiplier&&(o*=Weather.getEnemySpeedMultiplier()),void 0!==Seasons&&Seasons.getEnemySpeedMultiplier&&(o*=Seasons.getEnemySpeedMultiplier()),void 0!==Crafting&&Crafting.getMultiplier&&(o*=Crafting.getMultiplier("slow_enemies")),r*=o,this.useNoiseMovement&&void 0!==Noise&&(r*=Noise.getSpeedMultiplier(this.id,this.noiseTime)),i<=r?(this.x=a.x,this.y=a.y,this.pathIndex++,this.distanceTraveled+=i,this.pathIndex>=this.path.length&&(this.reachedEnd=!0)):(this.x+=t*(o=r/i),this.y+=n*o,this.distanceTraveled+=r),this.useNoiseMovement&&(this.noiseTime+=60*e),this.render()):this.reachedEnd=!0}},a.prototype.updateBoss=function(e){var e=1e3*e,t=d.boss.skills;this.shieldActive&&(this.shieldTimer-=e,this.shieldTimer<=0)&&(this.shieldActive=!1,this.armor=this.baseArmor,this.element.classList.remove("shielded"),"function"==typeof emitGameEvent)&&emitGameEvent(EVENTS.BOSS_SKILL_USED,{skill:"shieldEnd",boss:this}),this.summonCooldown-=e,this.shieldCooldown-=e,!this.enraged&&this.health<=this.maxHealth*t.enrage.healthThreshold&&(this.enraged=!0,this.baseSpeed*=1+t.enrage.speedBoost,this.speed=this.baseSpeed,this.damage*=t.enrage.damageMultiplier,this.element.classList.add("enraged"),this.bossPhase=2,"function"==typeof emitGameEvent)&&(emitGameEvent(EVENTS.BOSS_PHASE_CHANGE,{phase:2,boss:this}),emitGameEvent(EVENTS.BOSS_SKILL_USED,{skill:"enrage",boss:this})),this.summonCooldown<=0&&(this.useSummonSkill(),this.summonCooldown=t.summon.cooldown),this.shieldCooldown<=0&&!this.shieldActive&&this.health<.7*this.maxHealth&&(this.useShieldSkill(),this.shieldCooldown=t.shield.cooldown)},a.prototype.useSummonSkill=function(){for(var e=d.boss.skills.summon.count,t=0;t<e;t++)setTimeout(function(){Enemy.count()<50&&Enemy.spawn("slime")},200*t);this.element.classList.add("summoning");var a=this;setTimeout(function(){a.element&&a.element.classList.remove("summoning")},500),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.BOSS_SKILL_USED,{skill:"summon",boss:this,count:e})},a.prototype.useShieldSkill=function(){var e=d.boss.skills;this.shieldActive=!0,this.shieldTimer=e.shield.duration,this.armor=this.baseArmor+e.shield.armor,this.element.classList.add("shielded"),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.BOSS_SKILL_USED,{skill:"shield",boss:this,armor:e.shield.armor})},a.prototype.render=function(){var e,t,a;this.element&&(e=Path.GRID_COLS*Path.CELL_SIZE,t=Path.GRID_ROWS*Path.CELL_SIZE,e=this.x+e/2,t=this.y+t/2,this.useNoiseMovement&&void 0!==Noise&&(e+=(a=Noise.getPathOffset(this.id,this.distanceTraveled)).x,t+=a.y),this.element.style.left=e+"px",this.element.style.top=t+"px")},a.prototype.takeDamage=function(e){var e=Math.max(1,e-this.armor),e=(this.health-=e,Math.max(0,this.health/this.maxHealth*100)),t=this.element.querySelector(".health-fill");return t&&(t.style.width=e+"%"),this.health<=0&&(this.die(),!0)},a.prototype.applySlow=function(e,t){this.slowed=!0,this.slowTimer=t,this.speed=this.baseSpeed*(1-e),this.element.classList.add("slowed")},a.prototype.applyBurn=function(e,t,a){this.burning=!0,this.burnDamage=e,this.burnDuration=t,this.burnInterval=a,this.burnTimer=0,this.element.classList.add("burning")},a.prototype.die=function(){this.alive=!1,this.element.classList.add("dying"),this.createDeathParticles();var e=new CustomEvent("enemyKilled",{detail:{enemy:this,reward:this.reward}}),t=(document.dispatchEvent(e),this),e="boss"===this.type?1e3:600;setTimeout(function(){t.destroy()},e)},a.prototype.createDeathParticles=function(){var e=document.createElement("div");e.className="death-particles "+this.type,this.element.appendChild(e),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},500)},a.prototype.destroy=function(){this.element&&(void 0!==Pool&&this.element.dataset.poolType?Pool.release(this.element):this.element.parentNode&&this.element.parentNode.removeChild(this.element)),this.element=null;var e=i.indexOf(this);-1<e&&i.splice(e,1)},{init:function(){m=document.getElementById("enemies"),i=[],u=0},spawn:function(e,t){return t=new a(e,Path.getPathWaypoints(),t),i.push(t),"boss"===e&&"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.BOSS_SPAWNED,{boss:t}),t},update:function(e){for(var t=i.length-1;0<=t;t--){var a,n=i[t];n.update(e),n.reachedEnd&&n.alive&&(n.alive=!1,a=new CustomEvent("enemyReachedEnd",{detail:{enemy:n,damage:n.damage}}),document.dispatchEvent(a),n.destroy())}},getAll:function(){return i.filter(function(e){return e.alive})},getById:function(e){for(var t=0;t<i.length;t++)if(i[t].id===e)return i[t];return null},clear:function(){for(var e=i.length-1;0<=e;e--)i[e].destroy();i=[]},count:function(){return i.filter(function(e){return e.alive}).length},TYPES:d,VARIANTS:c}})(),Tower=(()=>{var i={arrow:{name:"Arrow Tower",cost:50,damage:15,range:120,fireRate:2,projectileType:"arrow",projectileSpeed:400,className:"tower-arrow",description:"Fast single-target attacks"},cannon:{name:"Cannon Tower",cost:100,damage:30,range:150,fireRate:.8,projectileType:"cannon",projectileSpeed:300,className:"tower-cannon",description:"Splash damage area attack",splashRadius:60},ice:{name:"Ice Tower",cost:75,damage:10,range:100,fireRate:1.5,projectileType:"ice",projectileSpeed:350,className:"tower-ice",description:"Slows enemies",slowEffect:.5,slowDuration:2},magic:{name:"Magic Tower",cost:150,damage:50,range:200,fireRate:.5,projectileType:"magic",projectileSpeed:250,className:"tower-magic",description:"High damage long range",ignoreArmor:!0},tesla:{name:"Tesla Tower",cost:200,damage:40,range:140,fireRate:2.5,projectileType:"tesla",projectileSpeed:1e3,className:"tower-tesla",description:"Zaps enemies instantly",chainTargets:3,chainDamageFalloff:.7},flame:{name:"Flame Tower",cost:250,damage:5,range:100,fireRate:10,projectileType:"flame",projectileSpeed:400,className:"tower-flame",description:"Burns enemies rapidly",burnDamage:3,burnDuration:3,burnInterval:.5}},n=[],r=0,s={swift:{name:"Swift",rarity:"common",fireRateMult:1.15,color:"#AAAAAA"},deadly:{name:"Deadly",rarity:"common",damageMult:1.2,color:"#AAAAAA"},keen:{name:"Keen",rarity:"common",rangeMult:1.1,color:"#AAAAAA"},arcane:{name:"Arcane",rarity:"rare",rangeMult:1.25,color:"#0088FF"},fierce:{name:"Fierce",rarity:"rare",damageMult:1.25,fireRateMult:1.05,color:"#0088FF"},rapid:{name:"Rapid",rarity:"rare",fireRateMult:1.25,color:"#0088FF"},mythical:{name:"Mythical",rarity:"epic",damageMult:1.15,fireRateMult:1.1,rangeMult:1.1,color:"#AA00FF"},godly:{name:"Godly",rarity:"epic",damageMult:1.3,rangeMult:1.15,color:"#AA00FF"},legendary:{name:"Legendary",rarity:"legendary",damageMult:1.25,fireRateMult:1.25,rangeMult:1.25,color:"#FF8800"}},l={common:60,rare:25,epic:12,legendary:3},o=null;function d(e,t,a){var n=i[e],e=(this.id=++r,this.type=e,this.config=n,this.gridX=t,this.gridY=a,Path.gridToWorld(t,a));this.x=e.x,this.y=e.y,this.z=0,this.baseDamage=n.damage,this.baseRange=n.range,this.baseFireRate=n.fireRate,this.level=1,this.prefix=null,this.damage=n.damage,this.range=n.range,this.fireRate=n.fireRate,this.target=null,this.lastFireTime=0,this.fireCooldown=1e3/n.fireRate,this.angle=0,this.element=this.createElement(),o.appendChild(this.element),this.render(),Path.occupyCell(t,a,this)}return d.prototype.createElement=function(){var e=document.createElement("div");switch(e.className="tower "+this.config.className,e.dataset.id=this.id,this.type){case"arrow":e.innerHTML='<div class="tower-base"></div><div class="tower-body"></div><div class="tower-top"></div><div class="tower-turret"></div>';break;case"cannon":e.innerHTML='<div class="tower-base"></div><div class="tower-body"></div><div class="tower-barrel"></div>';break;case"ice":e.innerHTML='<div class="tower-base"></div><div class="tower-crystal"></div><div class="tower-glow"></div><div class="ice-particles"></div>';break;case"magic":e.innerHTML='<div class="tower-base"></div><div class="tower-orb"></div><div class="tower-ring"></div><div class="magic-energy"></div>';break;case"tesla":e.innerHTML='<div class="tower-base"></div><div class="tower-coil"></div><div class="tower-spark"></div><div class="tesla-arc"></div>';break;case"flame":e.innerHTML='<div class="tower-base"></div><div class="tower-tank"></div><div class="tower-nozzle"></div><div class="flame-particles"></div>'}return e},d.prototype.update=function(e,t){this.findTarget(),this.target&&this.rotateToTarget(),this.target&&t-this.lastFireTime>=this.getEffectiveCooldown()&&this.fire(t)},d.prototype.getEffectiveRange=function(){var e=1;return void 0!==Weather&&Weather.getRangeMultiplier&&(e*=Weather.getRangeMultiplier()),void 0!==Seasons&&Seasons.getTowerModifier&&(e*=Seasons.getTowerModifier(this.type,"range")),void 0!==Weather&&Weather.getTowerModifier&&(e*=Weather.getTowerModifier(this.type,"range")),this.range*e},d.prototype.findTarget=function(){for(var e=Enemy.getAll(),t=null,a=1/0,n=this.getEffectiveRange(),i=0;i<e.length;i++){var r=e[i],o=r.x-this.x,s=r.y-this.y;(l=Math.sqrt(o*o+s*s))<=n&&l<a&&(t=r,a=l)}if(this.target&&this.target.alive){var l,o=this.target.x-this.x,s=this.target.y-this.y;if((l=Math.sqrt(o*o+s*s))<=n)return}var d=null!==this.target,c=null!==t;this.target=t,c&&!d?this.element.classList.add("targeting"):!c&&d&&this.element.classList.remove("targeting")},d.prototype.rotateToTarget=function(){var e,t;this.target&&(e=this.target.x-this.x,t=this.target.y-this.y,this.angle=Math.atan2(t,e)*(180/Math.PI)+90,t=this.element.querySelector(".tower-turret, .tower-barrel"))&&(t.style.transform="translateX(-50%) rotateZ("+this.angle+"deg)")},d.prototype.getEffectiveCooldown=function(){var e=1;return void 0!==Weather&&Weather.getTowerModifier&&(e*=Weather.getTowerModifier(this.type,"fireRate")),void 0!==Seasons&&Seasons.getTowerModifier&&(e*=Seasons.getTowerModifier(this.type,"fireRate")),void 0!==Crafting&&Crafting.getMultiplier&&(e*=Crafting.getMultiplier("attack_speed_mult")),this.fireCooldown/e},d.prototype.fire=function(e){var t,a,n;this.target&&(n="tower_fire_"+this.id,a=.9*this.fireCooldown,void 0!==Utils&&Utils.throttle(n,function(){},a),this.lastFireTime=e,this.element.classList.add("firing"),n="magic"===(t=this).type?400:"ice"===this.type?500:"cannon"===this.type?400:200,setTimeout(function(){t.element.classList.remove("firing")},n),a=this.damage,e=1,void 0!==Weather&&Weather.getTowerModifier&&(e*=Weather.getTowerModifier(this.type,"damage")),void 0!==Seasons&&Seasons.getTowerModifier&&(e*=Seasons.getTowerModifier(this.type,"damage")),void 0!==Crafting&&Crafting.getMultiplier&&(e*=Crafting.getMultiplier("damage_mult")),this.damage=Math.floor(a*e),Projectile.spawn(this,this.target),this.damage=a,n=new CustomEvent("towerFired",{detail:{tower:this,target:this.target,x:this.x,y:this.y}}),document.dispatchEvent(n))},d.prototype.render=function(){var e,t;this.element&&(e=Path.GRID_COLS*Path.CELL_SIZE,t=Path.GRID_ROWS*Path.CELL_SIZE,e=this.x+e/2,t=this.y+t/2,this.element.style.left=e+"px",this.element.style.top=t+"px")},d.prototype.upgrade=function(){return!(3<=this.level||(this.level++,this.applyPrefix(),this.element.classList.remove("level-1","level-2","level-3"),this.element.classList.add("level-"+this.level),this.updateLevelIndicator(),this.playUpgradeEffect(),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.TOWER_UPGRADED,{tower:this,level:this.level}),0))},d.prototype.playUpgradeEffect=function(){var e=this,t=(this.element.classList.add("upgrading"),document.createElement("div"));t.className="upgrade-particles",this.element.appendChild(t),setTimeout(function(){e.element.classList.remove("upgrading"),t.parentNode&&t.parentNode.removeChild(t)},600)},d.prototype.updateLevelIndicator=function(){var e=this.element.querySelector(".tower-level");if(e&&e.parentNode.removeChild(e),1<this.level){var t=document.createElement("div");t.className="tower-level";for(var a=0;a<this.level;a++){var n=document.createElement("div");n.className="level-star",t.appendChild(n)}this.element.appendChild(t)}},d.prototype.getUpgradeCost=function(){return 3<=this.level?1/0:Math.floor(.75*this.config.cost*this.level)},d.prototype.getSellValue=function(){for(var e=this.config.cost,t=2;t<=this.level;t++)e+=Math.floor(.75*this.config.cost*(t-1));return Math.floor(.6*e)},d.prototype.getReforgeCost=function(){return Math.floor(.5*this.config.cost)},d.prototype.reforge=function(){var e,t=100*Math.random(),a=0,n="common";for(e in l)if(t<(a+=l[e])){n=e;break}var i,r=[];for(i in s)s[i].rarity===n&&r.push(i);1<r.length&&this.prefix&&-1<(o=r.indexOf(this.prefix))&&r.splice(o,1);var o=r[Math.floor(Math.random()*r.length)];return this.prefix=o,this.applyPrefix(),s[o]},d.prototype.applyPrefix=function(){var e=1+.5*(this.level-1),t=1+.1*(this.level-1),a=1-.1*(this.level-1);this.damage=Math.floor(this.baseDamage*e),this.range=this.baseRange*t,this.fireCooldown=1e3/this.baseFireRate*a,this.prefix&&s[this.prefix]&&((e=s[this.prefix]).damageMult&&(this.damage=Math.floor(this.damage*e.damageMult)),e.rangeMult&&(this.range*=e.rangeMult),e.fireRateMult)&&(this.fireCooldown/=e.fireRateMult),this.updatePrefixVisual()},d.prototype.updatePrefixVisual=function(){var e,t=this.element.querySelector(".tower-prefix");t&&t.parentNode.removeChild(t),this.prefix&&s[this.prefix]&&(t=s[this.prefix],(e=document.createElement("div")).className="tower-prefix prefix-"+t.rarity,e.textContent=t.name,e.style.color=t.color,this.element.appendChild(e),this.element.classList.remove("prefix-common","prefix-rare","prefix-epic","prefix-legendary"),this.element.classList.add("prefix-"+t.rarity))},d.prototype.destroy=function(){Path.freeCell(this.gridX,this.gridY),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null;var e=n.indexOf(this);-1<e&&n.splice(e,1)},{init:function(){o=document.getElementById("towers"),n=[],r=0},create:function(e,t,a){return i[e]&&Path.canBuild(t,a)?(e=new d(e,t,a),n.push(e),t=new CustomEvent("towerPlaced",{detail:{tower:e}}),document.dispatchEvent(t),e):null},update:function(e,t){for(var a=0;a<n.length;a++)n[a].update(e,t)},getAll:function(){return n},getAt:function(e,t){for(var a=0;a<n.length;a++)if(n[a].gridX===e&&n[a].gridY===t)return n[a];return null},sell:function(e){var t=e.getSellValue(),e=(e.destroy(),new CustomEvent("towerSold",{detail:{gold:t}}));return document.dispatchEvent(e),t},clear:function(){for(var e=n.length-1;0<=e;e--)n[e].destroy();n=[]},getType:function(e){var t,a=i[e];return a?(a=Object.assign({},a),void 0!==Progression&&(a.cost=Math.floor(a.cost*Progression.getTowerCostMultiplier()),a.damage=Math.floor(a.damage*Progression.getDamageMultiplier()),a.range=Math.floor(a.range*Progression.getRangeMultiplier()),a.fireRate=a.fireRate*Progression.getAttackSpeedMultiplier(),a.splashRadius&&(a.splashRadius=Math.floor(a.splashRadius*Progression.getSplashRadiusMultiplier())),a.slowDuration)&&(a.slowDuration=a.slowDuration*Progression.getSlowDurationMultiplier()),void 0!==Weather&&Weather.getRangeMultiplier&&(t=Weather.getRangeMultiplier(),void 0!==Seasons&&Seasons.getTowerModifier&&(t*=Seasons.getTowerModifier(e,"range")),Weather.getTowerModifier&&(t*=Weather.getTowerModifier(e,"range")),a.range=Math.floor(a.range*t)),a):null},TYPES:i,PREFIXES:s}})(),Projectile=(()=>{var a=[],n=0,o=null;function i(e,t){this.id=++n,this.tower=e,this.target=t,this.type=e.config.projectileType,this.x=e.x,this.y=e.y,this.z=0,this.targetX=t.x,this.targetY=t.y,this.speed=e.config.projectileSpeed,this.damage=e.damage,this.splashRadius=e.config.splashRadius||0,this.slowEffect=e.config.slowEffect||0,this.slowDuration=e.config.slowDuration||0,this.ignoreArmor=e.config.ignoreArmor||!1,this.chainTargets=e.config.chainTargets||0,this.chainDamageFalloff=e.config.chainDamageFalloff||.7,this.burnDamage=e.config.burnDamage||0,this.burnDuration=e.config.burnDuration||0,this.burnInterval=e.config.burnInterval||.5;var t=this.targetX-this.x,e=this.targetY-this.y,a=Math.sqrt(t*t+e*e);this.dirX=t/a,this.dirY=e/a,this.angle=Math.atan2(e,t)*(180/Math.PI),this.alive=!0,this.distanceTraveled=0,this.maxDistance=a+50,this.element=this.createElement(),o.appendChild(this.element),this.render()}function r(e,t){var a,n;(t||"heavy"===e)&&t&&(a=document.getElementById("scene"))&&(t="heavy"===e?400:300,a.classList.add(n="heavy"===e?"screen-shake-heavy":"screen-shake"),setTimeout(function(){a.classList.remove(n)},t))}return i.prototype.createElement=function(){var e;return void 0!==Pool?e=Pool.acquire("projectile","projectile-"+this.type):(e=document.createElement("div")).className="projectile projectile-"+this.type,e.dataset.id=this.id,e},i.prototype.update=function(e){if(this.alive){e=this.speed*e;if(this.x+=this.dirX*e,this.y+=this.dirY*e,this.distanceTraveled+=e,this.target&&this.target.alive){var e=this.target.x-this.x,t=this.target.y-this.y;if(Math.sqrt(e*e+t*t)<15)return void this.hit();this.targetX=this.target.x,this.targetY=this.target.y;var e=this.targetX-this.x,t=this.targetY-this.y,a=Math.sqrt(e*e+t*t);0<a&&(this.dirX=e/a,this.dirY=t/a,this.angle=Math.atan2(t,e)*(180/Math.PI))}this.distanceTraveled>this.maxDistance?this.miss():this.render()}},i.prototype.render=function(){var e,t;this.element&&(e=Path.GRID_COLS*Path.CELL_SIZE,t=Path.GRID_ROWS*Path.CELL_SIZE,e=this.x+e/2,t=this.y+t/2,this.element.style.left=e+"px",this.element.style.top=t+"px",this.element.style.transform="translate(-50%, -50%) rotateX(-55deg) rotateZ("+this.angle+"deg)")},i.prototype.hit=function(){var e,t;this.alive=!1,this.createImpact(),0<this.splashRadius?this.applySplashDamage():this.target&&this.target.alive&&(this.ignoreArmor?(this.target.health-=this.damage,e=Math.max(0,this.target.health/this.target.maxHealth*100),(t=this.target.element.querySelector(".health-fill"))&&(t.style.width=e+"%"),this.target.health<=0&&this.target.die()):this.target.takeDamage(this.damage),0<this.slowEffect&&this.target.applySlow(this.slowEffect,this.slowDuration),0<this.burnDamage)&&this.target.alive&&this.target.applyBurn(this.burnDamage,this.burnDuration,this.burnInterval),0<this.chainTargets&&this.target&&this.target.alive&&this.applyChainLightning(),this.destroy()},i.prototype.applyChainLightning=function(){for(var e=Enemy.getAll(),t=[this.target],a=this.target,n=this.damage,i=0;i<this.chainTargets&&!((n=Math.floor(n*this.chainDamageFalloff))<1);i++){for(var r=null,o=1/0,s=0;s<e.length;s++){var l,d,c=e[s];c.alive&&-1===t.indexOf(c)&&(d=c.x-a.x,l=c.y-a.y,(d=Math.sqrt(d*d+l*l))<=100)&&d<o&&(r=c,o=d)}if(!r)break;r.takeDamage(n),t.push(r),this.createChainLightningEffect(a,r),a=r}},i.prototype.createChainLightningEffect=function(e,t){var a=document.createElement("div"),n=(a.className="chain-lightning",Path.GRID_COLS*Path.CELL_SIZE),i=Path.GRID_ROWS*Path.CELL_SIZE,r=e.x+n/2,e=e.y+i/2,n=t.x+n/2-r,t=t.y+i/2-e,i=Math.sqrt(n*n+t*t),t=Math.atan2(t,n)*(180/Math.PI);a.style.cssText="position: absolute; left: "+r+"px; top: "+e+"px; width: "+i+"px; height: 3px; background: linear-gradient(90deg, #00FFFF, #FFFFFF, #00FFFF); transform-origin: left center; transform: rotateX(55deg) rotateZ("+t+"deg); box-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF; pointer-events: none; z-index: 100;",o.appendChild(a),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},150)},i.prototype.applySplashDamage=function(){for(var e=Enemy.getAll(),t=0;t<e.length;t++){var a,n=e[t],i=n.x-this.x,r=n.y-this.y,i=Math.sqrt(i*i+r*r);i<=this.splashRadius&&(r=1-i/this.splashRadius*.5,i=Math.floor(this.damage*r),this.ignoreArmor?(n.health-=i,r=Math.max(0,n.health/n.maxHealth*100),(a=n.element.querySelector(".health-fill"))&&(a.style.width=r+"%"),n.health<=0&&n.die()):n.takeDamage(i),0<this.slowEffect)&&n.applySlow(this.slowEffect,this.slowDuration)}},i.prototype.createImpact=function(){void 0!==Pool?e=Pool.acquire("impact","impact-"+this.type):(e=document.createElement("div")).className="impact impact-"+this.type;var e,t=Path.GRID_COLS*Path.CELL_SIZE,a=Path.GRID_ROWS*Path.CELL_SIZE,t=this.x+t/2,a=this.y+a/2;switch(e.style.left=t+"px",e.style.top=a+"px",e.style.transform="translate(-50%, -50%) rotateX(-55deg)",this.type){case"arrow":var n=document.createElement("div");n.className="impact-sparks",e.appendChild(n);break;case"cannon":n=document.createElement("div"),n=(n.className="impact-debris",e.appendChild(n),document.createElement("div"));n.className="impact-smoke",e.appendChild(n),r("heavy");break;case"ice":n=document.createElement("div"),n=(n.className="impact-crystals",e.appendChild(n),document.createElement("div"));n.className="impact-frost-ring",e.appendChild(n);break;case"magic":n=document.createElement("div"),n=(n.className="impact-magic-particles",e.appendChild(n),document.createElement("div"));n.className="impact-magic-glow",e.appendChild(n),r("light");break;case"flame":var i,n=document.createElement("div"),n=(n.className="impact-flame-burst",e.appendChild(n),document.createElement("div"));n.className="impact-smoke",e.appendChild(n),this.target&&this.target.element&&void 0!==Effects&&(Effects.applyBurningEffect(this.target.element),i=this.target.element,setTimeout(function(){i&&void 0!==Effects&&Effects.removeBurningEffect(i)},3e3));break;case"tesla":n=document.createElement("div"),n=(n.className="impact-electric-arc",e.appendChild(n),document.createElement("div"));n.className="impact-spark-burst",e.appendChild(n),r("light")}o.appendChild(e);t="cannon"===this.type?800:"magic"===this.type||"ice"===this.type?700:"flame"===this.type?600:"tesla"===this.type?400:500;setTimeout(function(){void 0!==Pool&&e.dataset.poolType?(e.innerHTML="",Pool.release(e)):e.parentNode&&e.parentNode.removeChild(e)},t)},i.prototype.miss=function(){this.alive=!1,this.destroy()},i.prototype.destroy=function(){this.element&&(void 0!==Pool&&this.element.dataset.poolType?Pool.release(this.element):this.element.parentNode&&this.element.parentNode.removeChild(this.element)),this.element=null;var e=a.indexOf(this);-1<e&&a.splice(e,1)},{init:function(){o=document.getElementById("projectiles"),a=[],n=0},spawn:function(e,t){return e=new i(e,t),a.push(e),e},update:function(e){for(var t=a.length-1;0<=t;t--)a[t].update(e)},clear:function(){for(var e=a.length-1;0<=e;e--)a[e].destroy();a=[]}}})(),Wave=(()=>{var s={ANNOUNCEMENT:"announcement",SPAWN:"spawn",SPECIAL_EVENT:"specialEvent",BOSS_SPAWN:"bossSpawn",WARNING:"warning",DELAY:"delay"},l=[{events:[{time:0,type:"announcement",data:{title:"Wave 1",subtitle:"The slimes approach..."}},{time:2e3,type:"spawn",data:[{type:"slime",count:5,interval:1500}]}],reward:25},{events:[{time:0,type:"announcement",data:{title:"Wave 2",subtitle:"More slimes incoming!"}},{time:2e3,type:"spawn",data:[{type:"slime",count:8,interval:1200}]}],reward:30},{events:[{time:0,type:"announcement",data:{title:"Wave 3",subtitle:"Goblins join the fray!"}},{time:2e3,type:"spawn",data:[{type:"slime",count:5,interval:1500},{type:"goblin",count:3,interval:2e3}]}],reward:40},{events:[{time:0,type:"announcement",data:{title:"Wave 4",subtitle:"Goblin raiders!"}},{time:2e3,type:"spawn",data:[{type:"goblin",count:6,interval:1200},{type:"slime",count:4,interval:1e3}]}],reward:50},{events:[{time:0,type:"announcement",data:{title:"Wave 5",subtitle:"Armored knights approach!"}},{time:1500,type:"warning",data:{message:"Knights have high armor!"}},{time:3e3,type:"spawn",data:[{type:"slime",count:8,interval:1e3},{type:"goblin",count:5,interval:1500},{type:"knight",count:2,interval:3e3}]}],reward:75},{events:[{time:0,type:"announcement",data:{title:"Wave 6",subtitle:"The assault continues"}},{time:2e3,type:"spawn",data:[{type:"goblin",count:8,interval:1e3},{type:"knight",count:4,interval:2500}]}],reward:80},{events:[{time:0,type:"announcement",data:{title:"Wave 7",subtitle:"Gold rush!"}},{time:1e3,type:"specialEvent",data:{type:"goldRush",bonus:50}},{time:2500,type:"spawn",data:[{type:"slime",count:10,interval:800,variant:"speedy"},{type:"goblin",count:6,interval:1200},{type:"knight",count:5,interval:2e3}]}],reward:100},{events:[{time:0,type:"announcement",data:{title:"Wave 8",subtitle:"Elite forces!"}},{time:2e3,type:"spawn",data:[{type:"knight",count:8,interval:1500},{type:"goblin",count:10,interval:1e3,variant:"elite"}]}],reward:120},{events:[{time:0,type:"announcement",data:{title:"Wave 9",subtitle:"The horde approaches!"}},{time:1500,type:"warning",data:{message:"Prepare for the boss!"}},{time:3e3,type:"spawn",data:[{type:"slime",count:15,interval:600},{type:"goblin",count:10,interval:800},{type:"knight",count:6,interval:1800}]}],reward:150},{events:[{time:0,type:"announcement",data:{title:"FINAL WAVE",subtitle:"The Dark Lord awakens!"}},{time:2500,type:"warning",data:{message:"BOSS INCOMING!"}},{time:4e3,type:"spawn",data:[{type:"knight",count:4,interval:2e3}]},{time:1e4,type:"bossSpawn",data:{type:"boss"}}],reward:200}],d=0,c=!1,u=0,m=0,h=[],p=0,t=0,a=null;function v(e){switch(e.type){case"goldRush":void 0!==Game&&Game.addGold&&Game.addGold(e.bonus),void 0!==Display&&Display.showMessage("Gold Rush!");break;case"speedBoost":a={type:"speedBoost",duration:10},void 0!==Display&&Display.showAnnouncement("SPEED BOOST!","All towers fire 50% faster!");break;case"repair":void 0!==Game&&Game.addLives(5),void 0!==Display&&Display.showMessage("Repair Drone! +5 lives!");break;case"bloodMoon":a={type:"bloodMoon"},void 0!==Display&&Display.showAnnouncement("BLOOD MOON!","Enemies +30% HP, +50% gold!"),document.body.classList.add("blood-moon"),void 0!==Weather&&Weather.setBloodMoon&&Weather.setBloodMoon(!0);break;case"eliteSwarm":a={type:"eliteSwarm"},void 0!==Display&&Display.showAnnouncement("ELITE SWARM!","All enemies are Elite!");break;case"luckyStar":void 0!==Inventory&&Inventory.setDropMultiplier(2),a={type:"luckyStar"},void 0!==Display&&Display.showMessage("Lucky Star! Double drop rate!")}"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.SPECIAL_EVENT,e)}return{init:function(){c=!1,h=[],void(t=p=m=u=d=0)!==Noise&&Noise.init()},startWave:function(){if(c)return void 0!==Display&&Display.showMessage("Wave already in progress!"),!1;if(d>=l.length)return void 0!==Display&&Display.showMessage("All waves complete!"),!1;c=!0,h=[],p=m=u=0,t=(e=>{for(var t=l[e],a=0,n=0;n<t.events.length;n++){var i=t.events[n];if("spawn"===i.type)for(var r=0;r<i.data.length;r++)a+=i.data[r].count;else"bossSpawn"===i.type&&(a+=1)}return a})(d),(e=>{if(a&&"bloodMoon"===a.type&&(document.body.classList.remove("blood-moon"),void 0!==Weather)&&Weather.setBloodMoon&&Weather.setBloodMoon(!1),a&&"luckyStar"===a.type&&void 0!==Inventory&&Inventory.setDropMultiplier(1),a=null,e%2==0&&2<=e){var t=.025*e;if(Math.random()<t)return v({type:"bloodMoon"})}5<=e&&Math.random()<.1?v({type:"eliteSwarm"}):4<=e&&Math.random()<.1&&v({type:"luckyStar"})})(d+1);var e=new CustomEvent("waveStarted",{detail:{wave:d+1,totalWaves:l.length}});return document.dispatchEvent(e),!0},update:function(e){if(c){u+=1e3*e;for(var t,a,n=l[d];m<n.events.length;){var i=n.events[m];if(!(i.time<=u))break;r=void 0;var r=i;switch(r.type){case s.ANNOUNCEMENT:(e=>{var t,a,n=e.subtitle||"";void 0!==Seasons&&Seasons.getSeasonName&&(t=Seasons.getSeasonName(),a=void 0!==Weather&&Weather.isNight&&Weather.isNight()?"Night":"Day",n=t+" "+a+"  "+n),void 0!==Display&&Display.showAnnouncement&&Display.showAnnouncement(e.title,n),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.WAVE_ANNOUNCEMENT,e)})(r.data);break;case s.SPAWN:(e=>{for(var t=u,a=0;a<e.length;a++)for(var n=e[a],i=0;i<n.count;i++)h.push({type:n.type,variant:n.variant||null,spawnTime:t+i*n.interval+500*a});h.sort(function(e,t){return e.spawnTime-t.spawnTime})})(r.data);break;case s.SPECIAL_EVENT:v(r.data);break;case s.BOSS_SPAWN:(e=>{var t=document.querySelector(".boss-entrance-overlay"),a=(t||((t=document.createElement("div")).className="boss-entrance-overlay",document.body.appendChild(t)),document.querySelector(".boss-warning-text"));a||((a=document.createElement("div")).className="boss-warning-text",a.textContent="BOSS!",document.body.appendChild(a)),t.classList.add("active"),a.classList.add("active"),setTimeout(function(){t.classList.remove("active"),a.classList.remove("active")},3e3),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.BOSS_ENTRANCE,{type:"boss"}),void 0!==Display&&Display.showAnnouncement&&Display.showAnnouncement("BOSS","The Dark Lord has arrived!"),h.push({type:e.type,variant:null,spawnTime:u+1500}),void 0!==Sfx&&Sfx.play("bossSpawn")})(r.data);break;case s.WARNING:(e=>{void 0!==Display&&Display.showMessage(e.message,2500),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.WARNING,e)})(r.data);break;case s.DELAY:}m++}for(;0<h.length&&h[0].spawnTime<=u;){var o=h.shift();Enemy.spawn(o.type,o.variant),p++}m>=n.events.length&&0===h.length&&0===Enemy.count()&&c&&(c=!1,e=l[d],a=d+1,t=d>=l.length-1,d++,a=new CustomEvent("waveComplete",{detail:{wave:a,reward:e.reward,isLastWave:t}}),document.dispatchEvent(a))}},isGameComplete:function(){return d>=l.length&&!c&&0===Enemy.count()},getCurrentWave:function(){return Math.min(d+1,l.length)},getTotalWaves:function(){return l.length},isWaveInProgress:function(){return c},getProgress:function(){return c?0===t?0:(p-Enemy.count())/t:1},getNextWaveInfo:function(){if(d>=l.length)return null;for(var e=l[d],t={},a=0,n=0;n<e.events.length;n++){var i=e.events[n];if("spawn"===i.type)for(var r=0;r<i.data.length;r++){var o=i.data[r];t[o.type]=(t[o.type]||0)+o.count,a+=o.count}else"bossSpawn"===i.type&&(a+=t.boss=1)}return{wave:d+1,enemies:t,totalEnemies:a,reward:e.reward}},getActiveEvent:function(){return a},setCurrentWave:function(e){d=Math.max(0,Math.min(e-1,l.length))},EVENT_TYPES:s}})();function Announcer(e){var r=this;r.container=e,r.hideTimeout=null,r.showMessage=function(e,t,a){var n,i;t=!1!==t,a=a||3e3,r.hideTimeout&&(clearTimeout(r.hideTimeout),r.hideTimeout=null),i=e.title,(n=r.container.querySelector(".announcement-title"))&&(n.innerHTML=void 0===i?"":i),n=e.subtitle,(i=r.container.querySelector(".announcement-subtitle"))&&(i.innerHTML=void 0===n?"":n),r.container.classList.add("visible"),t&&(r.hideTimeout=setTimeout(function(){r.hideMessage()},a))},r.hideMessage=function(){r.container.classList.remove("visible"),r.hideTimeout&&(clearTimeout(r.hideTimeout),r.hideTimeout=null)}}var Display=(()=>{var s={},a=null,n=null;function i(){s.startWaveBtn&&(Wave.isWaveInProgress()?(s.startWaveBtn.disabled=!0,s.startWaveBtn.textContent="Wave in Progress..."):Wave.getCurrentWave()>Wave.getTotalWaves()?(s.startWaveBtn.disabled=!0,s.startWaveBtn.textContent="All Waves Complete!"):(s.startWaveBtn.disabled=!1,s.startWaveBtn.textContent="Start Wave "+Wave.getCurrentWave()))}function t(){s.towerOptions.forEach(function(e){e.dataset.tower;var t=parseInt(e.dataset.cost);Game.getGold()>=t?e.classList.remove("disabled"):e.classList.add("disabled")})}function r(e,t){s.message&&(t=t||2e3,a&&clearTimeout(a),s.message.textContent=e,s.message.style.opacity="1",a=setTimeout(function(){s.message.style.opacity="0"},t))}function o(){var e=document.getElementById("rangeIndicator");e&&e.parentNode.removeChild(e)}function l(){var e=document.getElementById("placementRange");e&&e.parentNode.removeChild(e)}var d={sun:'<circle cx="12" cy="12" r="5" fill="#F2D864" stroke="#1A1614" stroke-width="1.5"/><line x1="12" y1="2" x2="12" y2="5" stroke="#F2D864" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="22" stroke="#F2D864" stroke-width="2" stroke-linecap="round"/><line x1="2" y1="12" x2="5" y2="12" stroke="#F2D864" stroke-width="2" stroke-linecap="round"/><line x1="19" y1="12" x2="22" y2="12" stroke="#F2D864" stroke-width="2" stroke-linecap="round"/>',moon:'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#E8E0D8" stroke="#1A1614" stroke-width="1.5"/>',clear:'<circle cx="12" cy="12" r="5" fill="#F2D864" stroke="#1A1614" stroke-width="1.5"/><line x1="12" y1="3" x2="12" y2="6" stroke="#F2D864" stroke-width="1.5" stroke-linecap="round"/><line x1="12" y1="18" x2="12" y2="21" stroke="#F2D864" stroke-width="1.5" stroke-linecap="round"/>',rain:'<path d="M4 14h.01M8 14h.01" stroke="#4A90C4" stroke-width="2" stroke-linecap="round"/><path d="M20 10a4 4 0 0 0-8 0 3 3 0 0 0-3 3h14a3 3 0 0 0-3-3z" fill="#A0AAB4" stroke="#1A1614" stroke-width="1.5"/><line x1="8" y1="17" x2="7" y2="21" stroke="#4A90C4" stroke-width="1.5" stroke-linecap="round"/><line x1="14" y1="17" x2="13" y2="21" stroke="#4A90C4" stroke-width="1.5" stroke-linecap="round"/>',snow:'<circle cx="12" cy="12" r="2" fill="#FFF8F0" stroke="#4A90C4" stroke-width="1"/><line x1="12" y1="4" x2="12" y2="20" stroke="#4A90C4" stroke-width="1.5"/><line x1="5" y1="8" x2="19" y2="16" stroke="#4A90C4" stroke-width="1.5"/><line x1="5" y1="16" x2="19" y2="8" stroke="#4A90C4" stroke-width="1.5"/>',wind:'<path d="M5 12h14M5 8h10a3 3 0 0 0 0-6M5 16h8a3 3 0 0 1 0 6" fill="none" stroke="#A0AAB4" stroke-width="2" stroke-linecap="round"/>',summer:'<circle cx="12" cy="12" r="6" fill="#F2D864" stroke="#E88A42" stroke-width="2"/>',autumn:'<path d="M12 2C9 7 5 10 5 14a7 7 0 0 0 14 0c0-4-4-7-7-12z" fill="#D4884A" stroke="#1A1614" stroke-width="1.5"/>',winter:'<circle cx="12" cy="12" r="2" fill="#FFF8F0"/><line x1="12" y1="3" x2="12" y2="21" stroke="#4A90C4" stroke-width="1.5"/><line x1="4" y1="7.5" x2="20" y2="16.5" stroke="#4A90C4" stroke-width="1.5"/><line x1="4" y1="16.5" x2="20" y2="7.5" stroke="#4A90C4" stroke-width="1.5"/>',spring:'<circle cx="12" cy="12" r="4" fill="#F2D864" stroke="#1A1614" stroke-width="1"/><ellipse cx="12" cy="5" rx="3" ry="2" fill="#E8635A" stroke="#1A1614" stroke-width="0.8"/><ellipse cx="18" cy="10" rx="3" ry="2" fill="#E8635A" stroke="#1A1614" stroke-width="0.8" transform="rotate(60 18 10)"/><ellipse cx="16" cy="17" rx="3" ry="2" fill="#E8635A" stroke="#1A1614" stroke-width="0.8" transform="rotate(120 16 17)"/><ellipse cx="8" cy="17" rx="3" ry="2" fill="#E8635A" stroke="#1A1614" stroke-width="0.8" transform="rotate(60 8 17)"/><ellipse cx="6" cy="10" rx="3" ry="2" fill="#E8635A" stroke="#1A1614" stroke-width="0.8" transform="rotate(120 6 10)"/>'};function e(){var e,t=document.getElementById("envTimeIcon"),a=document.getElementById("envTimeLabel"),n=document.getElementById("envWeatherIcon"),i=document.getElementById("envWeatherLabel"),r=document.getElementById("envSeasonIcon"),o=document.getElementById("envSeasonLabel"),s=document.getElementById("envEvent"),l=document.getElementById("envEventLabel");document.getElementById("envTime"),document.getElementById("envWeather"),document.getElementById("envSeason");t&&a&&(e=!(void 0===Weather||!Weather.isNight)&&Weather.isNight(),t.innerHTML=e?d.moon:d.sun,a.textContent=e?"Night":"Day"),n&&i&&(t=void 0!==Weather&&Weather.getCurrentWeather?Weather.getCurrentWeather():"clear",n.innerHTML=d[t]||d.clear,i.textContent=t.charAt(0).toUpperCase()+t.slice(1)),r&&o&&(a=void 0!==Seasons&&Seasons.getCurrentSeason?Seasons.getCurrentSeason():"summer",e=void 0!==Seasons&&Seasons.getSeasonName?Seasons.getSeasonName():"Summer",r.innerHTML=d[a]||d.summer,o.textContent=e),s&&l&&(n=void 0!==Wave&&Wave.getActiveEvent?Wave.getActiveEvent():null,!(void 0===Weather||!Weather.isBloodMoon)&&Weather.isBloodMoon()||n&&"bloodMoon"===n.type?(s.classList.remove("hidden"),l.textContent="Blood Moon"):n&&"eliteSwarm"===n.type?(s.classList.remove("hidden"),l.textContent="Elite Swarm"):n&&"luckyStar"===n.type?(s.classList.remove("hidden"),l.textContent="Lucky Star"):s.classList.add("hidden"))}return document.addEventListener("waveStarted",function(){setTimeout(e,100)}),document.addEventListener("weatherChanged",function(){e()}),document.addEventListener("seasonChanged",function(){e()}),{init:function(){var e;s.loadingScreen=document.getElementById("loadingScreen"),s.gameOverScreen=document.getElementById("gameOverScreen"),s.gameOverTitle=document.getElementById("gameOverTitle"),s.finalScore=document.getElementById("finalScore"),s.gameUI=document.getElementById("gameUI"),s.lives=document.getElementById("lives"),s.gold=document.getElementById("gold"),s.wave=document.getElementById("wave"),s.totalWaves=document.getElementById("totalWaves"),s.score=document.getElementById("score"),s.startWaveBtn=document.getElementById("startWaveBtn"),s.shopPanel=document.getElementById("shopPanel"),s.towerOptions=document.querySelectorAll(".tower-option"),s.announcer=document.getElementById("announcer"),s.announcer&&(n=new Announcer(s.announcer)),(e=document.createElement("div")).id="gameMessage",e.className="game-message",e.style.cssText="position: fixed; top: 20%; left: 50%; transform: translateX(-50%); color: #FFD700; padding: 15px 30px; font-size: 1.5rem; font-weight: bold; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; text-align: center;",document.body.appendChild(e),s.message=e},updateGold:function(e){s.gold&&(s.gold.textContent=e,s.gold.style.transform="scale(1.2)",setTimeout(function(){s.gold.style.transform="scale(1)"},150)),t()},updateLives:function(e){s.lives&&(s.lives.textContent=e,s.lives.style.color=e<=5?"#F44336":"")},updateWave:function(e,t){s.wave&&(s.wave.textContent=e),s.totalWaves&&(s.totalWaves.textContent=t),i()},updateScore:function(e){s.score&&(s.score.textContent=e)},updateWaveButton:i,updateTowerAffordability:t,selectTower:function(t){s.towerOptions.forEach(function(e){e.dataset.tower===t?e.classList.add("selected"):e.classList.remove("selected")})},showMessage:r,showStartScreen:function(){s.loadingScreen&&s.loadingScreen.classList.remove("hidden")},hideStartScreen:function(){s.loadingScreen&&s.loadingScreen.classList.add("hidden")},showGameOverScreen:function(e,t,a){var n,i,r,o;s.gameOverScreen&&(s.gameOverScreen.classList.remove("hidden"),s.gameOverTitle&&(e?(s.gameOverTitle.textContent="Victory!",s.gameOverTitle.classList.add("victory")):(s.gameOverTitle.textContent="Game Over",s.gameOverTitle.classList.remove("victory"))),s.finalScore&&(s.finalScore.textContent=t),a)&&((e=document.getElementById("gameOverStats"))&&e.classList.remove("hidden"),t=document.getElementById("goWaves"),e=document.getElementById("goEnemies"),n=document.getElementById("goTowers"),i=document.getElementById("goGold"),r=document.getElementById("goDuration"),o=document.getElementById("goRank"),t&&(t.textContent=a.waveReached||"-"),e&&(e.textContent=a.enemiesKilled||"0"),n&&(n.textContent=a.towersBuilt||"0"),i&&(i.textContent=a.goldEarned||"0"),r&&(r.textContent=a.durationSeconds?(t=a.durationSeconds,e=Math.floor(t/60),t%=60,60<=e?Math.floor(e/60)+":"+((e%=60)<10?"0":"")+e+":"+(t<10?"0":"")+t:e+":"+(t<10?"0":"")+t):"-"),o)&&(o.textContent="-")},hideGameOverScreen:function(){s.gameOverScreen&&s.gameOverScreen.classList.add("hidden")},showGameUI:function(){s.gameUI&&s.gameUI.classList.remove("hidden"),i(),t()},hideGameUI:function(){s.gameUI&&s.gameUI.classList.add("hidden")},highlightCell:function(e,t,a){(e=document.querySelector('.cell[data-x="'+e+'"][data-y="'+t+'"]'))&&(e.classList.remove("valid-placement","invalid-placement"),a?e.classList.add("valid-placement"):e.classList.add("invalid-placement"))},clearHighlights:function(){document.querySelectorAll(".cell.valid-placement, .cell.invalid-placement").forEach(function(e){e.classList.remove("valid-placement","invalid-placement")})},showRangeIndicator:function(e){o();var t=document.createElement("div"),a=(t.className="range-indicator",e.type&&t.classList.add("range-"+e.type),t.id="rangeIndicator",2*e.range),a=(t.style.width=a+"px",t.style.height=a+"px",Path.GRID_COLS*Path.CELL_SIZE),n=Path.GRID_ROWS*Path.CELL_SIZE;t.style.left=e.x+a/2+"px",t.style.top=e.y+n/2+"px",t.style.transform="translate(-50%, -50%)",t.style.transformOrigin="center center",document.getElementById("map").appendChild(t)},hideRangeIndicator:o,showPlacementRange:function(e,t,a,n){l();var i=document.createElement("div"),n=(i.className="range-indicator placement-range",i.id="placementRange",n&&i.classList.add("range-"+n),2*a),a=(i.style.width=n+"px",i.style.height=n+"px",Path.gridToWorld(e,t)),n=Path.GRID_COLS*Path.CELL_SIZE,e=Path.GRID_ROWS*Path.CELL_SIZE;i.style.left=a.x+n/2+"px",i.style.top=a.y+e/2+"px",i.style.transform="translate(-50%, -50%)",i.style.transformOrigin="center center",document.getElementById("map").appendChild(i)},hidePlacementRange:l,showAnnouncement:function(e,t,a){n?n.showMessage({title:e,subtitle:t},!0,a||3e3):r(e+(t?" - "+t:""),a||3e3)},hideAnnouncement:function(){n&&n.hideMessage()},showCombo:function(e,t){var a=document.getElementById("comboDisplay"),e=(a||((a=document.createElement("div")).id="comboDisplay",a.className="combo-display",document.body.appendChild(a)),a.innerHTML='<div class="combo-count">'+e+'x</div><div class="combo-label">COMBO!</div>',a.classList.add("active"),Math.min(1+.1*(e-3),1.5));a.style.transform="translateX(-50%) scale("+e+")"},hideCombo:function(){var e=document.getElementById("comboDisplay");e&&e.classList.remove("active")},updateEnvironment:e}})(),Shop=(()=>{var t=null;function o(){t&&(t.element.classList.remove("selected"),Display.hideRangeIndicator(),l(),t=null)}function s(n){l();var e=document.createElement("div"),t=(e.id="towerActions",e.className="tower-actions",e.style.cssText="position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border-radius: 10px; padding: 15px; display: flex; gap: 15px; z-index: 200; pointer-events: auto;",document.createElement("div")),a=(t.className="tower-action-info",t.style.cssText="color: #fff; text-align: center; min-width: 100px;",n.config.name),i="#FFD700",a=(n.prefix&&Tower.PREFIXES[n.prefix]&&(a=(r=Tower.PREFIXES[n.prefix]).name+" "+n.config.name,i=r.color),t.innerHTML='<div style="font-weight: bold; color: '+i+';">'+a+'</div><div style="font-size: 0.8rem; margin-top: 5px;">Level '+n.level+'</div><div style="font-size: 0.8rem;">Damage: '+n.damage+'</div><div style="font-size: 0.8rem;">Range: '+Math.round(n.range)+"</div>",e.appendChild(t),n.level<3&&(r=n.getUpgradeCost(),(i=document.createElement("button")).className="action-btn upgrade-btn",i.style.cssText="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: #fff; font-size: 0.9rem;",i.innerHTML='Upgrade<br><span style="font-size: 0.75rem;">'+r+"g</span>",Game.getGold()<r?(i.style.opacity="0.5",i.style.cursor="not-allowed"):i.addEventListener("click",function(){var e=n,t=e.getUpgradeCost();if(Game.getGold()<t)Display.showMessage("Not enough gold!"),Sfx.play("error");else if(e.upgrade())return void(Game.spendGold(t),Display.showMessage("Tower upgraded!"),Sfx.play("upgrade"),s(e),Display.showRangeIndicator(e))}),e.appendChild(i)),n.getReforgeCost()),t=document.createElement("button"),r=(t.className="action-btn reforge-btn",t.style.cssText="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%); color: #fff; font-size: 0.9rem;",t.innerHTML='Reforge<br><span style="font-size: 0.75rem;">'+a+"g</span>",Game.getGold()<a?(t.style.opacity="0.5",t.style.cursor="not-allowed"):t.addEventListener("click",function(){var e,t=n,a=t.getReforgeCost();Game.getGold()<a?(Display.showMessage("Not enough gold!"),Sfx.play("error")):(Game.spendGold(a),e=(a=t.reforge()).rarity.charAt(0).toUpperCase()+a.rarity.slice(1),Display.showMessage(a.name+" "+t.config.name+"! ("+e+")"),Sfx.play("reforge"),void 0!==Achievements&&Achievements.checkReforgeAchievement(a),s(t),Display.showRangeIndicator(t))}),e.appendChild(t),n.getSellValue()),i=document.createElement("button");i.className="action-btn sell-btn",i.style.cssText="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: linear-gradient(135deg, #F44336 0%, #C62828 100%); color: #fff; font-size: 0.9rem;",i.innerHTML='Sell<br><span style="font-size: 0.75rem;">'+r+"g</span>",i.addEventListener("click",function(){var e;e=n,void 0!==Challenge&&Challenge.isActive()&&!Challenge.isSellAllowed()?(Display.showMessage("Cannot sell in this challenge!"),Sfx.play("error")):(Tower.sell(e),Display.showMessage("Tower Sold!"),o())}),e.appendChild(i),document.body.appendChild(e)}function l(){var e=document.getElementById("towerActions");e&&e.parentNode.removeChild(e)}return{init:function(){document.querySelectorAll(".tower-option").forEach(function(e){e.addEventListener("click",function(e){var t=this.dataset.tower,a=parseInt(this.dataset.cost);Game.getSelectedTowerType()===t?Game.selectTowerType(null):Game.getGold()<a?(Display.showMessage("Not enough gold!"),Sfx.play("error")):Game.selectTowerType(t)}),e.addEventListener("mouseenter",function(){var e=this.dataset.tower;Tower.getType(e)}),e.addEventListener("mouseleave",function(){})})},selectPlacedTower:function(e){t===e?o():((t=e).element.classList.add("selected"),Display.showRangeIndicator(e),s(e))},deselectTower:o,getSelectedTower:function(){return t},hideTowerActions:l}})(),Sfx=(()=>{var S=null,b=null,x=!1,t=.5,a=.3,n={menu:null,playing:null,victory:null,defeat:null},i={button:null,ready:null,place:null,upgrade:null,warning:null,death:null,blasts:[]},r=null,o=null,C=!1,M=720,L=480,T={},s=null,E=null,A=null,I=0,k=20;function P(e){if(S&&!x){e=T[e];if(e&&("suspended"===S.state&&S.resume(),!(k<=I)))try{if(e.layers)for(var t=e.layers,a=0;a<t.length;a++)(h=>{var e=1e3*(h.delay||0);setTimeout(function(){if(!(k<=I)){I++;var e=b;if(h.reverb&&A&&(t=h.reverb,e=A?((n=S.createConvolver()).buffer=A,(a=S.createGain()).gain.value=t||.3,n.connect(a),a.connect(b),n):b),"noise"===h.type){var t=h,a=e,n=S.currentTime,i=t.duration||.1,r=S.createBufferSource();if(E)r.buffer=E;else{for(var o=S.sampleRate*i,s=S.createBuffer(1,o,S.sampleRate),l=s.getChannelData(0),d=0;d<o;d++)l[d]=2*Math.random()-1;r.buffer=s}(s=S.createBiquadFilter()).type=t.filterType||"lowpass",s.frequency.value=t.filter||1e3;var c=S.createGain(),t=t.gain||.2;c.gain.setValueAtTime(t,n),c.gain.exponentialRampToValueAtTime(.001,n+i),r.connect(s),s.connect(c),c.connect(a),r.start(n),r.stop(n+i)}else{var s=h,c=e,r=S.createOscillator(),i=S.createGain(),e=S.currentTime,u=s.duration||.1,m=(r.type=s.type||"sine",r.frequency.setValueAtTime(s.freq||440,e),s.slide&&r.frequency.linearRampToValueAtTime(s.slide,e+u),s.gain||.3);i.gain.setValueAtTime(.001,e),i.gain.linearRampToValueAtTime(m,e+.005),i.gain.exponentialRampToValueAtTime(.001,e+u),(s.filter?((m=S.createBiquadFilter()).type=s.filterType||"lowpass",m.frequency.value=s.filter,r.connect(m),m):r).connect(i),i.connect(c),r.start(e),r.stop(e+u)}setTimeout(function(){I=Math.max(0,I-1)},1e3*(h.duration||.1)+50)}},e)})(t[a]);else if(e.pattern)for(var n=e,i=n.pattern,r=n.freq||440,o=n.duration/i.length,s=0;s<i.length;s++)((e,a)=>{setTimeout(function(){var e,t;0!==a&&(e=S.createOscillator(),t=S.createGain(),e.type=n.type||"sine",e.frequency.value=r*a,t.gain.value=.3,t.gain.exponentialRampToValueAtTime(.01,S.currentTime+.8*o),e.connect(t),t.connect(b),e.start(),e.stop(S.currentTime+.8*o))},e*o*1e3)})(s,i[s]);else if("noise"===e.type){for(var l=e,d=S.sampleRate*l.duration,c=S.createBuffer(1,d,S.sampleRate),u=c.getChannelData(0),m=0;m<d;m++)u[m]=2*Math.random()-1;var h=S.createBufferSource(),p=(h.buffer=c,(c=S.createBiquadFilter()).type="lowpass",c.frequency.value=l.filter||1e3,S.createGain());p.gain.value=l.gain||.2,p.gain.exponentialRampToValueAtTime(.01,S.currentTime+l.duration),h.connect(c),c.connect(p),p.connect(b),h.start(),h.stop(S.currentTime+l.duration)}else{var v,g,f=e,y=S.createOscillator(),w=S.createGain();y.type=f.type||"sine",y.frequency.value=f.freq||440,f.slide&&y.frequency.linearRampToValueAtTime(f.slide,S.currentTime+f.duration),w.gain.value=f.gain||.3,w.gain.exponentialRampToValueAtTime(.01,S.currentTime+f.duration),y.connect(w),f.harmonics&&(v=S.createOscillator(),g=S.createGain(),v.type=f.type,v.frequency.value=2*(f.freq||440),g.gain.value=.15,g.gain.exponentialRampToValueAtTime(.01,S.currentTime+f.duration),v.connect(g),g.connect(b),v.start(),v.stop(S.currentTime+f.duration)),w.connect(b),y.start(),y.stop(S.currentTime+f.duration)}}catch(e){console.warn("Error playing sound:",e)}}}function l(e){var t;r&&n[r]?((t=n[r]).fade(a,0,300),t.once("fade",function(){t.stop(),e&&e()})):e&&e()}function e(){r&&n[r]&&n[r].pause()}function d(){r&&n[r]&&!x&&n[r].play()}return{init:function(){try{if(S=new(window.AudioContext||window.webkitAudioContext),(s=S.createDynamicsCompressor()).threshold.value=-12,s.knee.value=10,s.ratio.value=4,s.attack.value=.003,s.release.value=.25,(b=S.createGain()).gain.value=t,b.connect(s),s.connect(S.destination),E=(e=>{for(var t=S.sampleRate*e,a=(e=S.createBuffer(1,t,S.sampleRate)).getChannelData(0),n=0;n<t;n++)a[n]=2*Math.random()-1;return e})(1),A=(e=>{for(var t=S.sampleRate*e,a=S.createBuffer(2,t,S.sampleRate),n=0;n<2;n++)for(var i=a.getChannelData(n),r=0;r<t;r++)i[r]=(2*Math.random()-1)*Math.pow(1-r/t,2.5);return a})(.8),S)try{(o=S.listener).positionX?(o.positionX.value=0,o.positionY.value=0,o.positionZ.value=3):o.setPosition&&o.setPosition(0,0,3),o.forwardX?(o.forwardX.value=0,o.forwardY.value=0,o.forwardZ.value=-1,o.upX.value=0,o.upY.value=1,o.upZ.value=0):o.setOrientation&&o.setOrientation(0,0,-1,0,1,0),C=!0}catch(e){console.warn("Spatial audio not supported:",e),C=!1}if(T={start:{layers:[{type:"sine",freq:440,duration:.15,slide:660},{type:"sine",freq:880,duration:.15,slide:1320,gain:.15,delay:.08}]},error:{layers:[{type:"sawtooth",freq:200,duration:.2,slide:100,gain:.2}]},place:{layers:[{type:"square",freq:330,duration:.08,slide:440,gain:.2},{type:"noise",duration:.04,filter:4e3,gain:.1}]},sell:{layers:[{type:"sine",freq:550,duration:.12,slide:330,gain:.25}]},upgrade:{layers:[{type:"sine",freq:440,duration:.15,slide:880,gain:.25},{type:"sine",freq:880,duration:.15,slide:1760,gain:.12},{type:"triangle",freq:220,duration:.2,gain:.1}]},shoot_arrow:{layers:[{type:"sawtooth",freq:600,duration:.06,slide:300,gain:.15,filter:2e3},{type:"noise",duration:.08,filter:6e3,gain:.1}]},shoot_cannon:{layers:[{type:"noise",duration:.15,filter:400,gain:.5},{type:"sine",freq:60,duration:.2,slide:30,gain:.4},{type:"noise",duration:.03,filter:8e3,gain:.15}]},shoot_ice:{layers:[{type:"sine",freq:1200,duration:.1,slide:800,gain:.2},{type:"sine",freq:1205,duration:.12,slide:795,gain:.1},{type:"noise",duration:.06,filter:8e3,gain:.05}]},shoot_magic:{layers:[{type:"sine",freq:600,duration:.2,slide:1200,gain:.2,reverb:.4},{type:"sine",freq:300,duration:.25,slide:150,gain:.1},{type:"noise",duration:.15,filter:3e3,gain:.05}]},shoot_tesla:{layers:[{type:"sawtooth",freq:800,duration:.06,slide:2e3,gain:.2},{type:"square",freq:100,duration:.04,gain:.1},{type:"noise",duration:.05,filter:5e3,gain:.08}]},shoot_flame:{layers:[{type:"noise",duration:.12,filter:600,filterType:"bandpass",gain:.25},{type:"sine",freq:80,duration:.15,gain:.15},{type:"noise",duration:.08,filter:3e3,gain:.06}]},kill:{layers:[{type:"noise",duration:.08,filter:2e3,gain:.2},{type:"sine",freq:800,duration:.12,slide:400,gain:.15}]},damage:{layers:[{type:"sawtooth",freq:150,duration:.2,slide:80,gain:.25}]},waveStart:{layers:[{type:"square",freq:330,duration:.1,gain:.2},{type:"square",freq:440,duration:.1,gain:.2,delay:.12},{type:"square",freq:550,duration:.15,gain:.2,delay:.24}]},waveComplete:{layers:[{type:"sine",freq:440,duration:.12,gain:.25},{type:"sine",freq:550,duration:.12,gain:.25,delay:.1},{type:"sine",freq:660,duration:.15,gain:.25,delay:.2},{type:"sine",freq:880,duration:.2,gain:.2,delay:.3}]},bossSpawn:{layers:[{type:"sawtooth",freq:80,duration:1.5,slide:40,gain:.35},{type:"sine",freq:40,duration:1.5,slide:20,gain:.3},{type:"noise",duration:1,filter:200,gain:.15}]},bossSkill:{layers:[{type:"sine",freq:200,duration:.3,slide:600,gain:.25},{type:"sine",freq:400,duration:.3,slide:1200,gain:.12}]},gameOver:{layers:[{type:"sawtooth",freq:400,duration:.3,slide:200,gain:.25},{type:"sawtooth",freq:300,duration:.3,slide:100,gain:.2,delay:.25},{type:"sawtooth",freq:200,duration:.5,slide:80,gain:.2,delay:.5}]},victory:{layers:[{type:"sine",freq:523,duration:.15,gain:.25},{type:"sine",freq:659,duration:.15,gain:.25,delay:.12},{type:"sine",freq:784,duration:.15,gain:.25,delay:.24},{type:"sine",freq:1047,duration:.3,gain:.2,delay:.36}]},comboKill:{layers:[{type:"sine",freq:880,duration:.08,gain:.2},{type:"sine",freq:1100,duration:.1,gain:.2,delay:.06}]},reforge:{layers:[{type:"noise",duration:.05,filter:5e3,gain:.3},{type:"sine",freq:800,duration:.1,slide:1200,gain:.2,delay:.03},{type:"triangle",freq:2e3,duration:.15,slide:1e3,gain:.1,delay:.05}]},achievement:{layers:[{type:"sine",freq:523,duration:.1,gain:.2},{type:"sine",freq:659,duration:.1,gain:.2,delay:.08},{type:"sine",freq:784,duration:.1,gain:.2,delay:.16},{type:"sine",freq:1047,duration:.1,gain:.2,delay:.24},{type:"sine",freq:1318,duration:.2,gain:.15,delay:.32}]},goldPickup:{layers:[{type:"sine",freq:1200,duration:.06,gain:.12},{type:"sine",freq:1600,duration:.08,gain:.1,delay:.04}]},bossEnrage:{layers:[{type:"sawtooth",freq:100,duration:.8,slide:400,gain:.3},{type:"noise",duration:.5,filter:1e3,gain:.2},{type:"square",freq:50,duration:.6,slide:200,gain:.15}]},bossShield:{layers:[{type:"sine",freq:400,duration:.3,slide:1200,gain:.2,reverb:.5},{type:"sine",freq:600,duration:.3,slide:1800,gain:.15,delay:.05},{type:"triangle",freq:800,duration:.4,slide:2400,gain:.1,delay:.1}]},powerup:{layers:[{type:"sine",freq:440,duration:.15,slide:880,gain:.2},{type:"sine",freq:660,duration:.15,slide:1320,gain:.15,delay:.1}]}},"undefined"==typeof Howl)console.warn("Howler.js not loaded, music disabled");else{n.menu=new Howl({src:["assets/sfx/musics/hall.mp3"],loop:!0,volume:a,preload:!0}),n.playing=new Howl({src:["assets/sfx/musics/gameing.mp3"],loop:!0,volume:a,preload:!0}),n.victory=new Howl({src:["assets/sfx/musics/win.mp3"],loop:!1,volume:a,preload:!0}),n.defeat=new Howl({src:["assets/sfx/musics/fail.mp3"],loop:!1,volume:a,preload:!0}),i.button=new Howl({src:["assets/sfx/effects/button.mp3"],volume:t,preload:!0}),i.ready=new Howl({src:["assets/sfx/effects/ready.mp3"],volume:t,preload:!0}),i.place=new Howl({src:["assets/sfx/effects/reset.mp3"],volume:t,preload:!0}),i.upgrade=new Howl({src:["assets/sfx/effects/buff.mp3"],volume:t,preload:!0}),i.warning=new Howl({src:["assets/sfx/effects/warn.mp3"],volume:t,preload:!0}),i.death=new Howl({src:["assets/sfx/effects/death.wav"],volume:.5*t,preload:!0});for(var e=1;e<=5;e++)i.blasts.push(new Howl({src:["assets/sfx/blasts/blast"+e+".mp3"],volume:.6*t,preload:!0}))}}catch(e){console.warn("Web Audio API not supported:",e)}},play:P,playSpatial:function(t,e,a){if(S&&!x&&C){var n,i,r=T[t];if(r){"suspended"===S.state&&S.resume();try{var o,s,l=e/(M/2)*2,d=a/(L/2)*2,l=Math.max(-3,Math.min(3,l)),d=Math.max(-3,Math.min(3,d)),c=S.createStereoPanner?(n=l,(i=S.createStereoPanner()).pan.value=Math.max(-1,Math.min(1,n)),i.connect(b),i):((e,t)=>{var a=S.createPanner();return a.panningModel="HRTF",a.distanceModel="inverse",a.refDistance=1,a.maxDistance=10,a.rolloffFactor=1,a.coneInnerAngle=360,a.coneOuterAngle=0,a.coneOuterGain=0,a.positionX?(a.positionX.value=e,a.positionY.value=t,a.positionZ.value=0):a.setPosition(e,t,0),a.connect(b),a})(l,d),u=r,m=c;if("noise"===u.type){for(var h=u,p=m,v=S.sampleRate*h.duration,g=S.createBuffer(1,v,S.sampleRate),f=g.getChannelData(0),y=0;y<v;y++)f[y]=2*Math.random()-1;var w=S.createBufferSource(),E=(w.buffer=g,(g=S.createBiquadFilter()).type="lowpass",g.frequency.value=h.filter||1e3,S.createGain());E.gain.value=h.gain||.2,E.gain.exponentialRampToValueAtTime(.01,S.currentTime+h.duration),w.connect(g),g.connect(E),E.connect(p),w.start(),w.stop(S.currentTime+h.duration)}else o=S.createOscillator(),s=S.createGain(),o.type=u.type||"sine",o.frequency.value=u.freq||440,u.slide&&o.frequency.linearRampToValueAtTime(u.slide,S.currentTime+u.duration),s.gain.value=u.gain||.3,s.gain.exponentialRampToValueAtTime(.01,S.currentTime+u.duration),o.connect(s),s.connect(m),o.start(),o.stop(S.currentTime+u.duration)}catch(e){console.warn("Error playing spatial sound:",e),P(t)}}}else P(t)},playEffect:function(e){var t;x||("blast"===e?0<i.blasts.length&&(t=Math.floor(Math.random()*i.blasts.length),i.blasts[t].play()):i[e]&&i[e].play())},playMusic:function(e){!n[e]||x||l(function(){n[r=e].play(),n[e].fade(0,a,500)})},stopMusic:l,pauseMusic:e,resumeMusic:d,setVolume:function(e){t=Math.max(0,Math.min(1,e)),b&&(b.gain.value=t)},getVolume:function(){return t},setMusicVolume:function(e){a=Math.max(0,Math.min(1,e)),Object.keys(n).forEach(function(e){n[e]&&n[e].volume(a)})},getMusicVolume:function(){return a},toggleMute:function(){return x=!x,b&&(b.gain.value=x?0:t),(x?e:d)(),x},isMuted:function(){return x},setMapDimensions:function(e,t){M=e,L=t}}})(),EVENTS={BOSS_SPAWNED:"bossSpawned",BOSS_PHASE_CHANGE:"bossPhaseChange",BOSS_SKILL_USED:"bossSkillUsed",BOSS_ENTRANCE:"bossEntrance",COMBO_KILL:"comboKill",TOWER_UPGRADED:"towerUpgraded",SPECIAL_EVENT:"specialEvent",WAVE_ANNOUNCEMENT:"waveAnnouncement",WARNING:"warning"};function emitGameEvent(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t||{}}))}var Game=(()=>{var i={MENU:"menu",PLAYING:"playing",PAUSED:"paused",GAME_OVER:"gameOver",VICTORY:"victory"},n={normal:{name:"Normal",healthMult:1,damageMult:1,goldMult:1,xpMult:1},hard:{name:"Hard",healthMult:1.5,damageMult:1.5,goldMult:1.3,xpMult:1.5},expert:{name:"Expert",healthMult:2,damageMult:2,goldMult:1.5,xpMult:2}},r=i.MENU,o="normal",s=100,a=20,l=0,d=0,c=0,u=0,m=1.5,h=3,p=0,v=0,g=null,f=0,y=0,w=0,E=null;function S(){var e,t;r===i.PLAYING&&(t=((e=performance.now())-p)/1e3,p=e,Wave.update(t=.1<t?.1:t),Weather.update(t),Enemy.update(t),Tower.update(t,e),Projectile.update(t),0<c&&(u-=t)<=0&&(h<=c&&x(5*c),c=0,Display.hideCombo()),a<=0?(r=i.GAME_OVER,g&&(cancelAnimationFrame(g),g=null),d<l&&(d=l,localStorage.setItem("towerDefenseHighScore",d)),e=Math.floor((performance.now()-v)/1e3),t={score:l,difficulty:o,waveReached:Wave.getCurrentWave(),towersBuilt:y,enemiesKilled:f,durationSeconds:e,goldEarned:w,outcome:"defeat"},void 0!==API&&(API.submitScore(t),API.recordGame(t),API.getMyRank)&&API.getMyRank(o).then(function(e){var t;e&&e.rank&&(t=document.getElementById("goRank"))&&(t.textContent="#"+e.rank)}),void 0!==Challenge&&Challenge.isActive()&&(t=Math.floor(l*Challenge.getScoreBonus()),void 0!==API&&API.completeDailyChallenge&&API.completeDailyChallenge({score:t,durationSeconds:e,metadata:{outcome:"defeat",waveReached:Wave.getCurrentWave()}}),Challenge.end()),Display.showGameOverScreen(!1,l,{waveReached:Wave.getCurrentWave(),enemiesKilled:f,towersBuilt:y,goldEarned:w,durationSeconds:e}),Sfx.play("gameOver"),Sfx.playMusic("defeat")):Wave.isGameComplete()?b():g=requestAnimationFrame(S))}function b(){r=i.VICTORY,g&&(cancelAnimationFrame(g),g=null);d<(l+=100*a)&&(d=l,localStorage.setItem("towerDefenseHighScore",d));var e=Math.floor((performance.now()-v)/1e3),t={score:l,difficulty:o,waveReached:Wave.getCurrentWave(),towersBuilt:y,enemiesKilled:f,durationSeconds:e,goldEarned:w,outcome:"victory"};void 0!==API&&(API.submitScore(t),API.recordGame(t),API.getMyRank)&&API.getMyRank(o).then(function(e){var t;e&&e.rank&&(t=document.getElementById("goRank"))&&(t.textContent="#"+e.rank)}),void 0!==Challenge&&Challenge.isActive()&&(t=Math.floor(l*Challenge.getScoreBonus()),void 0!==API&&API.completeDailyChallenge&&API.completeDailyChallenge({score:t,durationSeconds:e,metadata:{outcome:"victory",waveReached:Wave.getCurrentWave()}}),Challenge.end()),Display.showGameOverScreen(!0,l,{waveReached:Wave.getCurrentWave(),enemiesKilled:f,towersBuilt:y,goldEarned:w,durationSeconds:e}),Sfx.play("victory"),Sfx.playMusic("victory")}function x(e){s+=e,Display.updateGold(s),void 0!==Achievements&&Achievements.checkGoldAchievements(s)}function C(e){return e<=s&&(s-=e,Display.updateGold(s),!0)}function M(e){l+=e,Display.updateScore(l)}function L(e){a+=e,Display.updateLives(a)}function T(e){return!(e&&!Tower.getType(e)||(E=e,Display.selectTower(e),0))}return{init:function(){d=parseInt(localStorage.getItem("towerDefenseHighScore"))||0,void 0!==Utils&&Utils.resetThrottles(),void 0!==Pool&&Pool.init(),Path.init(),Path.render(),Weather.init(),Seasons.init(),Progression.init(),void 0!==Inventory&&Inventory.init(),void 0!==Achievements&&Achievements.init(),void 0!==Crafting&&Crafting.init(),void 0!==Effects&&Effects.init(),Enemy.init(),Tower.init(),Projectile.init(),Wave.init(),document.addEventListener("enemyKilled",function(e){var e=e.detail.reward,t=1,a=(void 0!==Weather&&Weather.getGoldMultiplier&&(t*=Weather.getGoldMultiplier()),void 0!==Seasons&&Seasons.getGoldMultiplier&&(t*=Seasons.getGoldMultiplier()),void 0!==Crafting&&Crafting.getMultiplier?Crafting.getMultiplier("gold_mult"):1),e=Math.floor(e*n[o].goldMult*Progression.getGoldMultiplier()*t*a);u=m,h<=++c&&(e+=t=Math.floor(.1*e*(c-h+1)),Display.showCombo(c,t)),x(e),w+=e,f++,M(10*e),Sfx.play("kill"),"function"==typeof emitGameEvent&&emitGameEvent(EVENTS.COMBO_KILL,{count:c,reward:e})}),document.addEventListener("enemyReachedEnd",function(e){e=e.detail.damage;(e=void 0!==Crafting&&Crafting.absorbDamage?Crafting.absorbDamage(e):e)<=0||((a-=e)<0&&(a=0),Display.updateLives(a)),Sfx.play("damage")}),document.addEventListener("waveStarted",function(e){Display.updateWave(e.detail.wave,e.detail.totalWaves),Sfx.play("waveStart")}),document.addEventListener("waveComplete",function(e){var t=e.detail.reward;x(t=void 0!==Seasons&&Seasons.getWaveRewardMultiplier?Math.floor(t*Seasons.getWaveRewardMultiplier()):t),M(5*t),Display.showMessage("Wave Complete!"),Sfx.play("waveComplete"),Display.updateWave(Wave.getCurrentWave(),Wave.getTotalWaves()),6<=e.detail.wave&&a<10&&Math.random()<.2&&(L(5),Display.showMessage("Repair Drone!"),Sfx.play("powerup")),e.detail.isLastWave&&b()}),document.addEventListener("towerPlaced",function(e){y++,Sfx.play("place")}),document.addEventListener("towerFired",function(e){var t=e.detail.tower.type,a=e.detail.x||0,e=e.detail.y||0;Sfx.playSpatial?Sfx.playSpatial("shoot_"+t,a,e):Sfx.play("shoot_"+t)}),document.addEventListener("towerSold",function(e){x(e.detail.gold),Sfx.play("sell")}),document.addEventListener("bossPhaseChange",function(e){"enrage"===e.detail.phase?Sfx.play("bossEnrage"):"shield"===e.detail.phase&&Sfx.play("bossShield")}),document.addEventListener("comboKill",function(e){3<=e.detail.count&&Sfx.play("comboKill")}),Display.updateGold(s),Display.updateLives(a),Display.updateScore(l),Display.updateWave(Wave.getCurrentWave(),Wave.getTotalWaves()),document.addEventListener("click",function e(){r===i.MENU&&Sfx.playMusic("menu"),document.removeEventListener("click",e)},{once:!0})},start:function(){var e;r!==i.MENU&&r!==i.GAME_OVER&&r!==i.VICTORY||(s=100+Progression.getStartingGoldBonus(),a=20+Progression.getExtraLives(),void(l=0)!==Challenge&&Challenge.isActive()&&(void 0!==(e=Challenge.getStartModifiers()).gold&&(s=e.gold),void 0!==e.lives)&&(a=e.lives),E=null,w=y=f=0,v=performance.now(),Enemy.clear(),Tower.clear(),Projectile.clear(),Path.init(),Path.render(),Wave.init(),void 0!==Pool&&Pool.clear(),void 0!==Challenge&&Challenge.isActive()&&(e=Challenge.getStartModifiers()).startWave&&1<e.startWave&&Wave.setCurrentWave(e.startWave),Display.updateGold(s),Display.updateLives(a),Display.updateScore(l),Display.updateWave(Wave.getCurrentWave(),Wave.getTotalWaves()),Display.hideStartScreen(),Display.hideGameOverScreen(),Display.showGameUI(),r=i.PLAYING,p=performance.now(),S(),Sfx.play("start"),Sfx.playMusic("playing"))},pause:function(){r===i.PLAYING&&(r=i.PAUSED,g&&(cancelAnimationFrame(g),g=null),Sfx.pauseMusic())},resume:function(){r===i.PAUSED&&(r=i.PLAYING,p=performance.now(),S(),Sfx.resumeMusic())},selectTowerType:T,placeTower:function(e,t){if(!E)return!1;if(r!==i.PLAYING)return!1;var a=Tower.getType(E);if(!a)return!1;if(void 0!==Challenge&&Challenge.isActive()&&!Challenge.isTowerAllowed(E))return Display.showMessage("Tower not allowed in this challenge!"),Sfx.play("error"),T(null),!1;if(void 0!==Challenge&&Challenge.isActive()){var n=Challenge.getMaxTowers();if(Tower.getAll().length>=n)return Display.showMessage("Tower limit reached! (max "+n+")"),Sfx.play("error"),T(null),!1}return s<a.cost?(Display.showMessage("Not enough gold!"),Sfx.play("error"),T(null),!1):Path.canBuild(e,t)?!!Tower.create(E,e,t)&&(C(a.cost),!0):(Display.showMessage("Cannot build here!"),Sfx.play("error"),!1)},startNextWave:function(){return r!==i.PLAYING?(Display.showMessage("Game not active!"),!1):Wave.isWaveInProgress()?(Display.showMessage("Clear current wave first!"),!1):Wave.startWave()},getState:function(){return r},getGold:function(){return s},getScore:function(){return l},getLives:function(){return a},getSelectedTowerType:function(){return E},canAfford:function(e){return(e=Tower.getType(e))&&s>=e.cost},addGold:x,spendGold:C,addLives:L,setDifficulty:function(e){n[e]&&(o=e)},getDifficulty:function(){return n[o]},getDifficultyName:function(){return n[o].name},getGameStateForSave:function(){return{difficulty:o,gold:s,lives:a,score:l,currentWave:Wave.getCurrentWave(),towers:Tower.getAll?Tower.getAll().map(function(e){return{type:e.type,gridX:e.gridX,gridY:e.gridY}}):[],inventory:void 0!==Inventory&&Inventory.getState?Inventory.getState():{}}},loadFromSave:function(e){e&&(o=e.difficulty||"normal",Enemy.clear(),Tower.clear(),Projectile.clear(),Path.init(),Path.render(),Wave.init(),void 0!==Pool&&Pool.clear(),s=e.gold||100,a=e.lives||20,l=e.score||0,E=null,w=y=f=0,v=performance.now(),e.towers&&0<e.towers.length&&e.towers.forEach(function(e){Tower.create(e.type,e.gridX,e.gridY),y++}),e.currentWave&&1<e.currentWave&&Wave.setCurrentWave(e.currentWave),Display.updateGold(s),Display.updateLives(a),Display.updateScore(l),Display.updateWave(Wave.getCurrentWave(),Wave.getTotalWaves()),Display.hideStartScreen(),Display.hideGameOverScreen(),Display.showGameUI(),r=i.PLAYING,p=performance.now(),S(),Sfx.play("start"),Sfx.playMusic("playing"))},STATES:i,DIFFICULTIES:n}})(),Achievements=(()=>{var n={"achievement-icon-blood":'<svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 2C12 2 6 10 6 14c0 3.31 2.69 6 6 6s6-2.69 6-6c0-4-6-12-6-12z" fill="#E8635A" stroke="#1A1614" stroke-width="1.2"/><ellipse cx="10" cy="14" rx="2" ry="3" fill="rgba(255,255,255,0.3)" transform="rotate(-10 10 14)"/></svg>',"achievement-icon-medal":'<svg viewBox="0 0 24 24" width="28" height="28"><polygon points="8,1 10,1 12,6 14,1 16,1 13,8 11,8" fill="#4A90C4" stroke="#1A1614" stroke-width="0.8"/><circle cx="12" cy="14" r="6" fill="#F2D864" stroke="#1A1614" stroke-width="1.2"/><circle cx="12" cy="14" r="4" fill="none" stroke="#C4A030" stroke-width="1"/><text x="12" y="17" text-anchor="middle" font-size="7" font-weight="bold" fill="#C4A030" font-family="sans-serif">1</text></svg>',"achievement-icon-trophy":'<svg viewBox="0 0 24 24" width="28" height="28"><path d="M7 3h10v6c0 3-2.5 5-5 5s-5-2-5-5V3z" fill="#F2D864" stroke="#1A1614" stroke-width="1.2"/><path d="M7 5H4c0 3 1.5 4 3 4" fill="none" stroke="#1A1614" stroke-width="1.2"/><path d="M17 5h3c0 3-1.5 4-3 4" fill="none" stroke="#1A1614" stroke-width="1.2"/><rect x="10" y="14" width="4" height="3" fill="#C4A030"/><rect x="8" y="17" width="8" height="3" rx="1" fill="#1A1614"/><ellipse cx="11" cy="7" rx="2" ry="3" fill="rgba(255,255,255,0.3)" transform="rotate(-5 11 7)"/></svg>',"achievement-icon-star":'<svg viewBox="0 0 24 24" width="28" height="28"><polygon points="12,2 14.9,8.6 22,9.3 16.8,14 18.2,21 12,17.5 5.8,21 7.2,14 2,9.3 9.1,8.6" fill="#F2D864" stroke="#1A1614" stroke-width="1.2"/><polygon points="12,5 13.5,9 10,9" fill="rgba(255,255,255,0.3)"/></svg>',"achievement-icon-fire":'<svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 23c-4.5 0-7-3-7-6.5 0-4 3-7 4.5-9.5.5 2 2 3 2 3s-0.5-4 2-7c1.5 2 2.5 3.5 3 5.5.3-.8.5-2 .5-2 2 3 2.5 5.5 2.5 7.5 0 4.5-3 9-7.5 9z" fill="#E8635A" stroke="#1A1614" stroke-width="1"/><path d="M12 23c-2.5 0-4-2-4-4 0-2.5 2-4.5 3-6 .5 1.5 1 2 1 2s0 -2 1.5-4c.5 1 1 2 1.5 3 0 0 .5-1 .5-1.5 1 1.5 1.5 3 1.5 4.5 0 3-2 6-5 6z" fill="#F2D864"/><ellipse cx="12" cy="20" rx="2" ry="3" fill="#FFF8F0" opacity="0.6"/></svg>',"achievement-icon-explosion":'<svg viewBox="0 0 24 24" width="28" height="28"><polygon points="12,1 14,7 20,4 16,9 23,12 16,14 20,20 14,16 12,23 10,16 4,20 8,14 1,12 8,9 4,4 10,7" fill="#E8635A" stroke="#1A1614" stroke-width="0.8"/><circle cx="12" cy="12" r="4" fill="#F2D864"/><circle cx="12" cy="12" r="2" fill="#FFF8F0"/></svg>',"achievement-icon-crown":'<svg viewBox="0 0 24 24" width="28" height="28"><path d="M4 18L2 8l5 4 5-7 5 7 5-4-2 10z" fill="#F2D864" stroke="#1A1614" stroke-width="1.2"/><rect x="4" y="18" width="16" height="3" rx="1" fill="#C4A030" stroke="#1A1614" stroke-width="1"/><circle cx="6" cy="8" r="1.2" fill="#E8635A"/><circle cx="12" cy="5" r="1.2" fill="#E8635A"/><circle cx="18" cy="8" r="1.2" fill="#E8635A"/></svg>',"achievement-icon-castle":'<svg viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="10" width="18" height="12" fill="#888" stroke="#1A1614" stroke-width="1"/><rect x="3" y="7" width="3" height="3" fill="#888" stroke="#1A1614" stroke-width="0.8"/><rect x="8" y="7" width="3" height="3" fill="#888" stroke="#1A1614" stroke-width="0.8"/><rect x="13" y="7" width="3" height="3" fill="#888" stroke="#1A1614" stroke-width="0.8"/><rect x="18" y="7" width="3" height="3" fill="#888" stroke="#1A1614" stroke-width="0.8"/><rect x="9" y="16" width="6" height="6" rx="3" fill="#1A1614"/><rect x="10" y="12" width="4" height="3" fill="#4A90C4" stroke="#1A1614" stroke-width="0.8"/></svg>',"achievement-icon-sparkle":'<svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 2L13.5 9 20 8l-5.5 3.5L18 18l-6-3-6 3 3.5-6.5L4 8l6.5 1z" fill="#F2D864" stroke="#1A1614" stroke-width="0.8"/><circle cx="12" cy="10" r="2" fill="#FFF8F0"/><circle cx="6" cy="4" r="1" fill="#F2D864"/><circle cx="19" cy="3" r="0.8" fill="#F2D864"/><circle cx="20" cy="16" r="0.6" fill="#F2D864"/></svg>',"achievement-icon-gold":'<svg viewBox="0 0 24 24" width="28" height="28"><ellipse cx="12" cy="16" rx="8" ry="4" fill="#C4A030" stroke="#1A1614" stroke-width="1"/><ellipse cx="12" cy="14" rx="8" ry="4" fill="#F2D864" stroke="#1A1614" stroke-width="1"/><ellipse cx="12" cy="12" rx="8" ry="4" fill="#C4A030" stroke="#1A1614" stroke-width="1"/><ellipse cx="12" cy="10" rx="8" ry="4" fill="#F2D864" stroke="#1A1614" stroke-width="1"/><ellipse cx="10" cy="9" rx="2.5" ry="1.5" fill="rgba(255,255,255,0.3)" transform="rotate(-5 10 9)"/></svg>'},i={first_blood:{name:"First Blood",description:"Kill your first enemy",reward:10,icon:"achievement-icon-blood",unlocked:!1},wave_5:{name:"Veteran",description:"Reach wave 5",reward:25,icon:"achievement-icon-medal",unlocked:!1},survivor:{name:"Survivor",description:"Complete all 10 waves",reward:100,icon:"achievement-icon-trophy",unlocked:!1},perfect_wave:{name:"Perfect Wave",description:"Complete a wave without taking damage",reward:50,icon:"achievement-icon-star",unlocked:!1},combo_5:{name:"Combo Master",description:"Achieve a 5x combo",reward:30,icon:"achievement-icon-fire",unlocked:!1},combo_10:{name:"Combo Legend",description:"Achieve a 10x combo",reward:75,icon:"achievement-icon-explosion",unlocked:!1},boss_slayer:{name:"Boss Slayer",description:"Defeat the boss",reward:50,icon:"achievement-icon-crown",unlocked:!1},tower_master:{name:"Tower Master",description:"Place 10 towers in one game",reward:25,icon:"achievement-icon-castle",unlocked:!1},reforger:{name:"Lucky Reforge",description:"Get a Legendary prefix",reward:50,icon:"achievement-icon-sparkle",unlocked:!1},rich:{name:"Wealthy",description:"Have 500 gold at once",reward:25,icon:"achievement-icon-gold",unlocked:!1}},t=0,a=0,r=0;function o(e){var t,a=i[e];a&&!a.unlocked&&(a.unlocked=!0,s(),void 0!==API&&API.unlockAchievement&&API.unlockAchievement(e),void 0!==Game&&Game.addGold&&Game.addGold(a.reward),e=a,(t=document.createElement("div")).className="achievement-notification",a=n[e.icon]||"",t.innerHTML='<div class="achievement-icon">'+a+'</div><div class="achievement-info"><div class="achievement-title">Achievement Unlocked!</div><div class="achievement-name">'+e.name+'</div><div class="achievement-reward">+'+e.reward+" gold</div></div>",document.body.appendChild(t),setTimeout(function(){t.classList.add("show")},100),setTimeout(function(){t.classList.remove("show"),setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t)},500)},4e3),void 0!==Sfx)&&Sfx.play("achievement")}function s(){var e,t=[];for(e in i)i[e].unlocked&&t.push(e);localStorage.setItem("td_achievements",JSON.stringify(t))}function l(){void 0!==API&&void 0!==Auth&&Auth.isLoggedIn()&&API.getAchievements().then(function(e){var t;e&&e.achievements&&(t=!1,e.achievements.forEach(function(e){i[e.achievementId]&&!i[e.achievementId].unlocked&&(i[e.achievementId].unlocked=!0,t=!0)}),t)&&s()})}return document.addEventListener("authStateChanged",function(e){e.detail&&e.detail.user&&l()}),{init:function(){r=a=t=0;try{var e=localStorage.getItem("td_achievements");e&&JSON.parse(e).forEach(function(e){i[e]&&(i[e].unlocked=!0)})}catch(e){}document.addEventListener("enemyKilled",function(e){1===++r&&o("first_blood"),e.detail.enemy&&"boss"===e.detail.enemy.type&&o("boss_slayer")}),document.addEventListener("comboKill",function(e){5<=e.detail.count&&o("combo_5"),10<=e.detail.count&&o("combo_10")}),document.addEventListener("waveStarted",function(e){void 0!==Game&&Game.getLives&&(t=Game.getLives())}),document.addEventListener("waveComplete",function(e){5<=e.detail.wave&&o("wave_5"),void 0!==Game&&Game.getLives&&Game.getLives()>=t&&0<t&&o("perfect_wave"),e.detail.isLastWave&&o("survivor")}),document.addEventListener("towerPlaced",function(e){10<=++a&&o("tower_master")})},unlock:o,checkGoldAchievements:function(e){500<=e&&o("rich")},checkReforgeAchievement:function(e){e&&"legendary"===e.rarity&&o("reforger")},getAll:function(){return i},getUnlockedCount:function(){var e,t=0;for(e in i)i[e].unlocked&&t++;return t},loadFromServer:l,ACHIEVEMENTS:i,ACHIEVEMENT_SVGS:n}})();(()=>{var l=null;function d(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function c(e){var t;void 0!==API&&void 0!==Game&&(t=Game.getGameStateForSave(),API.saveGame(e,t).then(function(e){e&&(Display.showMessage("Game Saved!"),Sfx.play("powerup"))}))}function u(t){void 0!==API&&API.getSaves().then(function(e){e&&e.saves&&e.saves[t]?(Game.loadFromSave(e.saves[t]),Display.showMessage("Game Loaded!")):Display.showMessage("No save in slot "+(t+1))})}function m(){var e,t,a;void 0!==API&&((e=document.getElementById("leaderboardModal"))&&e.parentNode.removeChild(e),(t=document.createElement("div")).className="auth-modal",t.id="leaderboardModal",t.innerHTML='<div class="auth-modal-content save-load-content"><h2 class="auth-modal-title">Leaderboard</h2><div class="lb-tabs"><button class="lb-tab selected" data-diff="normal">Normal</button><button class="lb-tab" data-diff="hard">Hard</button><button class="lb-tab" data-diff="expert">Expert</button></div><div class="leaderboard-list lb-full-list" id="lbFullList"><div class="leaderboard-loading">Loading...</div></div><div class="lb-my-rank" id="lbMyRank"></div><button class="auth-close" id="lbClose">&times;</button></div>',document.body.appendChild(t),document.getElementById("lbClose").addEventListener("click",function(){t.parentNode.removeChild(t)}),(a=t.querySelectorAll(".lb-tab")).forEach(function(e){e.addEventListener("click",function(){a.forEach(function(e){e.classList.remove("selected")}),e.classList.add("selected"),n(e.dataset.diff)})}),n("normal"))}function n(e){var t=document.getElementById("lbFullList"),a=document.getElementById("lbMyRank");t&&(t.innerHTML='<div class="leaderboard-loading">Loading...</div>',a&&(a.innerHTML=""),API.getLeaderboard(e,50,0).then(function(e){e&&e.entries&&0!==e.entries.length?(t.innerHTML="",e.entries.forEach(function(n){var e=document.createElement("div");e.className="leaderboard-row",n.userId&&(e.style.cursor="pointer",e.addEventListener("click",function(){var e,t,a;e=n.userId,void 0!==API&&API.getPlayerProfile&&((t=document.getElementById("profileModal"))&&t.parentNode.removeChild(t),(a=document.createElement("div")).className="auth-modal",a.id="profileModal",a.innerHTML='<div class="auth-modal-content profile-card"><h2 class="auth-modal-title">Player Profile</h2><div id="profileContent"><div class="leaderboard-loading">Loading...</div></div><button class="auth-close" id="profileClose">&times;</button></div>',document.body.appendChild(a),document.getElementById("profileClose").addEventListener("click",function(){a.parentNode.removeChild(a)}),API.getPlayerProfile(e).then(function(e){var t=document.getElementById("profileContent");t&&e?t.innerHTML='<div class="profile-name">'+d(e.displayName||"Player")+'</div><div class="stats-grid"><div class="stat-card"><div class="stat-card-label">Games</div><div class="stat-card-value">'+(e.totalGamesPlayed||0)+'</div></div><div class="stat-card"><div class="stat-card-label">Wins</div><div class="stat-card-value">'+(e.wins||0)+'</div></div><div class="stat-card"><div class="stat-card-label">Best Score</div><div class="stat-card-value">'+(e.maxScore||0)+'</div></div><div class="stat-card"><div class="stat-card-label">Achievements</div><div class="stat-card-value">'+(e.achievementCount||0)+"</div></div></div>":t&&(t.innerHTML='<div class="leaderboard-loading">Profile not found</div>')}).catch(function(){var e=document.getElementById("profileContent");e&&(e.innerHTML='<div class="leaderboard-loading">Could not load profile</div>')}))})),e.innerHTML='<span class="leaderboard-rank">#'+n.rank+'</span><span class="leaderboard-name">'+d(n.displayName)+'</span><span class="leaderboard-score">'+n.score+"</span>",t.appendChild(e)})):t.innerHTML='<div class="leaderboard-loading">No scores yet</div>'}).catch(function(){t.innerHTML='<div class="leaderboard-loading">Failed to load</div>'}),void 0!==Auth)&&Auth.isLoggedIn()&&API.getMyRank(e).then(function(e){e&&e.rank&&a&&(a.innerHTML='<div class="lb-my-rank-text">Your rank: <strong>#'+e.rank+"</strong></div>")})}function h(){var e,t;void 0!==API&&void 0!==Auth&&Auth.isLoggedIn()&&((e=document.getElementById("statsModal"))&&e.parentNode.removeChild(e),(t=document.createElement("div")).className="auth-modal",t.id="statsModal",t.innerHTML='<div class="auth-modal-content save-load-content"><h2 class="auth-modal-title">My Stats</h2><div id="statsContent"><div class="leaderboard-loading">Loading...</div></div><button class="auth-close" id="statsClose">&times;</button></div>',document.body.appendChild(t),document.getElementById("statsClose").addEventListener("click",function(){t.parentNode.removeChild(t)}),API.getMyStats().then(function(e){var t,a,n=document.getElementById("statsContent");n&&e?(t=e.stats,n.innerHTML='<div class="stats-grid"><div class="stat-card"><div class="stat-card-label">Games Played</div><div class="stat-card-value">'+t.totalGames+'</div></div><div class="stat-card"><div class="stat-card-label">Win Rate</div><div class="stat-card-value">'+t.winRate+'%</div></div><div class="stat-card"><div class="stat-card-label">Best Score</div><div class="stat-card-value">'+t.maxScore+'</div></div><div class="stat-card"><div class="stat-card-label">Avg Score</div><div class="stat-card-value">'+t.avgScore+"</div></div></div>",e.recentGames&&0<e.recentGames.length&&(a='<h3 style="color:#F2D864;font-family:Bangers;margin:15px 0 8px;">Recent Games</h3>',e.recentGames.forEach(function(e){var t="victory"===e.outcome?"#5EA65E":"#E8635A";a+='<div class="leaderboard-row"><span style="color:'+t+';width:60px;">'+e.outcome+'</span><span class="leaderboard-name">Wave '+e.waveReached+'</span><span class="leaderboard-score">'+e.score+"</span></div>"}),n.innerHTML+=a)):n&&(n.innerHTML='<div class="leaderboard-loading">No stats yet</div>')}))}function p(){if(void 0!==Achievements){var e,t=document.getElementById("achGalleryModal"),a=(t&&t.parentNode.removeChild(t),document.createElement("div")),n=(a.className="auth-modal",a.id="achGalleryModal",Achievements.getAll()),i=Achievements.ACHIEVEMENT_SVGS||{},r="";for(e in n){var o=n[e],s=i[o.icon]||"";r+='<div class="ach-card'+(o.unlocked?"":" ach-locked")+'" data-id="'+e+'"><div class="ach-icon">'+s+'</div><div class="ach-name">'+o.name+'</div><div class="ach-desc">'+o.description+'</div><div class="ach-reward">+'+o.reward+'g</div><div class="ach-global" id="achGlobal_'+e+'"></div></div>'}a.innerHTML='<div class="auth-modal-content ach-content"><h2 class="auth-modal-title">Achievements</h2><div class="ach-grid">'+r+'</div><button class="auth-close" id="achGalleryClose">&times;</button></div>',document.body.appendChild(a),document.getElementById("achGalleryClose").addEventListener("click",function(){a.parentNode.removeChild(a)}),void 0!==API&&API.getGlobalAchievements&&API.getGlobalAchievements().then(function(e){if(e&&e.percentages)for(var t in e.percentages){var a=document.getElementById("achGlobal_"+t);a&&(a.textContent=e.percentages[t]+"% of players")}}).catch(function(){})}}document.addEventListener("DOMContentLoaded",function(){var e,a,t,n,i,o,r,s;Sfx.init(),Display.init(),Shop.init(),void 0!==Auth&&Auth.init(),Game.init(),t=document.getElementById("loadingScreen"),s=document.getElementById("startBtn"),t&&s&&(e=!1,t.addEventListener("click",function(){e||(e=!0,Sfx.playMusic("menu"))},{once:!0}),(a=document.querySelectorAll(".difficulty-btn")).forEach(function(t){t.addEventListener("click",function(e){e.stopPropagation(),a.forEach(function(e){e.classList.remove("selected")}),t.classList.add("selected"),Game.setDifficulty(t.dataset.difficulty),Sfx.playEffect("button")})}),s.addEventListener("click",function(e){e.stopPropagation(),Sfx.playEffect("button"),t.classList.add("hidden"),Game.start()})),(s=document.getElementById("restartBtn"))&&s.addEventListener("click",function(){Sfx.playEffect("button"),Game.start()}),(s=document.getElementById("startWaveBtn"))&&s.addEventListener("click",function(){Sfx.playEffect("ready"),Game.startNextWave()}),(s=document.getElementById("map"))&&(s.addEventListener("click",function(e){var t,e=e.target.closest(".cell");e&&(t=parseInt(e.dataset.x),e=parseInt(e.dataset.y),Game.getSelectedTowerType()?Path.canBuild(t,e)&&(Game.placeTower(t,e),Display.clearHighlights()):(t=Tower.getAt(t,e))?Shop.selectPlacedTower(t):Shop.deselectTower())}),s.addEventListener("mousemove",function(e){var t,a,e=e.target.closest(".cell");e!==l&&(Display.clearHighlights(),Display.hidePlacementRange(),l=e)&&Game.getSelectedTowerType()&&(t=parseInt(e.dataset.x),e=parseInt(e.dataset.y),a=Path.canBuild(t,e),Display.highlightCell(t,e,a),a=Tower.getType(Game.getSelectedTowerType()))&&Display.showPlacementRange(t,e,a.range,Game.getSelectedTowerType())}),s.addEventListener("mouseleave",function(){Display.clearHighlights(),Display.hidePlacementRange(),l=null}),s.addEventListener("contextmenu",function(e){e.preventDefault(),Game.selectTowerType(null),Shop.deselectTower(),Display.clearHighlights()})),document.addEventListener("keydown",function(e){if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName)switch(e.key.toLowerCase()){case"1":Game.selectTowerType("arrow");break;case"2":Game.selectTowerType("cannon");break;case"3":Game.selectTowerType("ice");break;case"4":Game.selectTowerType("magic");break;case"escape":Game.selectTowerType(null),Shop.deselectTower(),Display.clearHighlights();break;case" ":case"enter":e.preventDefault(),Game.getState()===Game.STATES.MENU?Game.start():Game.getState()===Game.STATES.PLAYING&&Game.startNextWave();break;case"p":Game.getState()===Game.STATES.PLAYING?(Game.pause(),Display.showMessage("Paused - Press P to resume")):Game.getState()===Game.STATES.PAUSED&&Game.resume();break;case"m":var t=Sfx.toggleMute();Display.showMessage(t?"Sound Off":"Sound On");break;case"l":m();break;case"s":Game.getState()===Game.STATES.MENU&&h();break;case"a":Game.getState()===Game.STATES.MENU&&p()}}),document.getElementById("loadingScreen")&&((s=document.createElement("button")).className="auth-btn hidden",s.id="saveLoadBtn",s.textContent="Load Game",s.addEventListener("click",function(e){e.stopPropagation(),function r(){if(void 0===API)return;var e=document.getElementById("saveLoadModal");e&&e.parentNode.removeChild(e);var o=document.createElement("div");o.className="auth-modal";o.id="saveLoadModal";o.innerHTML='<div class="auth-modal-content save-load-content"><h2 class="auth-modal-title">Load Game</h2><div class="save-slots" id="saveSlots"><div class="save-slot-loading">Loading saves...</div></div><button class="auth-close" id="saveLoadClose">&times;</button></div>';document.body.appendChild(o);document.getElementById("saveLoadClose").addEventListener("click",function(){o.parentNode.removeChild(o)});API.getSaves().then(function(e){var t=document.getElementById("saveSlots");if(t)if(t.innerHTML="",e&&e.saves){for(var a=0;a<3;a++){var n=e.saves[a],i=document.createElement("div");i.className="save-slot"+(n?"":" save-slot-empty"),i.innerHTML=n?'<div class="save-slot-name">'+(n.saveName||"Save "+(a+1))+'</div><div class="save-slot-info">Wave '+n.currentWave+" | Score: "+n.score+" | "+n.difficulty+'</div><div class="save-slot-actions"><button class="save-slot-btn load-btn" data-slot="'+a+'">Load</button><button class="save-slot-btn delete-btn" data-slot="'+a+'">Delete</button></div>':'<div class="save-slot-name">Slot '+(a+1)+'</div><div class="save-slot-info">Empty</div>',t.appendChild(i)}t.querySelectorAll(".load-btn").forEach(function(t){t.addEventListener("click",function(){var e=parseInt(t.dataset.slot),e=(o.parentNode.removeChild(o),u(e),document.getElementById("loadingScreen"));e&&e.classList.add("hidden")})}),t.querySelectorAll(".delete-btn").forEach(function(t){t.addEventListener("click",function(){var e=parseInt(t.dataset.slot);API.deleteSave(e).then(function(){r()})})})}else t.innerHTML='<div class="save-slot-empty">Could not load saves</div>'})}()}),(i=document.getElementById("authContainer"))&&i.appendChild(s),(i=document.getElementById("saveGameBtn"))&&i.addEventListener("click",function(e){e.stopPropagation(),Game.getState()===Game.STATES.PLAYING&&void 0!==Auth&&Auth.isLoggedIn()&&c(0)}),document.addEventListener("keydown",function(e){"F5"===e.key&&Game.getState()===Game.STATES.PLAYING&&void 0!==Auth&&Auth.isLoggedIn()&&(e.preventDefault(),c(0)),"F9"===e.key&&Game.getState()===Game.STATES.PLAYING&&void 0!==Auth&&Auth.isLoggedIn()&&(e.preventDefault(),u(0))})),(s=document.getElementById("craftBtn"))&&s.addEventListener("click",function(e){e.stopPropagation(),function a(){if(void 0===Crafting)return;var e=document.getElementById("craftModal");e&&e.parentNode.removeChild(e);var t=document.createElement("div");t.className="auth-modal";t.id="craftModal";var n=Crafting.RECIPES;var i=void 0!==Inventory?Inventory.getInventory():{};var r="";e=Crafting.getActiveBuffs();var o=Crafting.getShieldCharges();(0<e.length||0<o)&&(r='<div class="active-buffs">',e.forEach(function(e){r+='<span class="buff-pill">'+e.name+" ("+e.wavesRemaining+"w)</span>"}),0<o&&(r+='<span class="buff-pill">Shield x'+o+"</span>"),r+="</div>");var s="";for(var l in n){var d,c=n[l],u=void 0!==Inventory&&Inventory.hasMaterials(c.cost),m=[];for(d in c.cost){var h=d.charAt(0).toUpperCase()+d.slice(1),p=i[d]||0,v=c.cost[d];m.push('<span class="mat-'+d+'">'+v+" "+h+(p<v?" ("+p+")":"")+"</span>")}s+='<div class="craft-card'+(u?"":" craft-disabled")+'" data-recipe="'+l+'"><div class="craft-name">'+c.name+'</div><div class="craft-effect">'+c.description+'</div><div class="craft-cost">'+m.join(" + ")+"</div></div>"}t.innerHTML='<div class="auth-modal-content craft-content"><h2 class="auth-modal-title">Crafting</h2><div style="text-align:center;font-family:Bangers;margin-bottom:8px;">Materials: <span style="color:#888">'+(i.scrap||0)+' Scrap</span> <span style="color:#0088FF">'+(i.core||0)+' Core</span> <span style="color:#AA00FF">'+(i.crystal||0)+" Crystal</span></div>"+r+'<div class="craft-grid">'+s+'</div><button class="auth-close" id="craftClose">&times;</button></div>';document.body.appendChild(t);document.getElementById("craftClose").addEventListener("click",function(){t.parentNode.removeChild(t)});t.querySelectorAll(".craft-card:not(.craft-disabled)").forEach(function(t){t.addEventListener("click",function(){var e=t.dataset.recipe;Crafting.craft(e)&&a()})})}()}),void 0!==API&&(n=document.getElementById("leaderboardList"))&&((i=document.getElementById("viewLeaderboardBtn"))&&i.addEventListener("click",function(e){e.stopPropagation(),m()}),API.getLeaderboard("normal",10,0).then(function(e){e&&e.entries&&0!==e.entries.length?(n.innerHTML="",e.entries.forEach(function(e){var t=document.createElement("div");t.className="leaderboard-row",t.innerHTML='<span class="leaderboard-rank">#'+e.rank+'</span><span class="leaderboard-name">'+d(e.displayName)+'</span><span class="leaderboard-score">'+e.score+"</span>",n.appendChild(t)})):n.innerHTML='<div class="leaderboard-loading">No scores yet. Be the first!</div>'}).catch(function(){n.innerHTML='<div class="leaderboard-loading">Leaderboard unavailable</div>'})),void 0!==API&&API.getDailyChallenge&&(o=document.getElementById("challengeSection"))&&API.getDailyChallenge().then(function(t){var e,a,n,i,r;t&&t.challenge&&(o.style.display="",e=document.getElementById("challengeName"),a=document.getElementById("challengeDesc"),n=document.getElementById("challengeLb"),i=document.getElementById("challengePlayBtn"),e&&(e.textContent=t.challenge.name),a&&(a.textContent=t.challenge.description),n&&t.topScores&&0<t.topScores.length&&(r="",t.topScores.slice(0,3).forEach(function(e,t){r+="#"+(t+1)+" "+d(e.displayName)+" - "+e.score+"  "}),n.textContent=r),i&&void 0!==Auth&&Auth.isLoggedIn()&&API.getMyChallenges&&API.getMyChallenges().then(function(e){var t;e&&(t=(new Date).toISOString().slice(0,10),e.completions&&e.completions.some(function(e){return e.date===t})&&(i.textContent="Completed",i.disabled=!0,i.style.opacity="0.6",i.style.cursor="default"),0<e.streak)&&n&&(e=e.streak+" day streak",n.textContent=(n.textContent?n.textContent+" | ":"")+e)}).catch(function(){}),i)&&i.addEventListener("click",function(e){e.stopPropagation(),i.disabled||void 0!==Challenge&&(Game.setDifficulty("normal"),Challenge.startChallenge(t.challenge.id),(e=document.getElementById("loadingScreen"))&&e.classList.add("hidden"),Game.start())})}).catch(function(){}),document.addEventListener("authStateChanged",function(e){var t=document.getElementById("saveGameBtn"),a=document.getElementById("statsBtn");e.detail&&e.detail.user?(t&&t.classList.remove("hidden"),a&&a.classList.remove("hidden")):(t&&t.classList.add("hidden"),a&&a.classList.add("hidden"))}),(s=document.getElementById("authContainer"))&&((r=document.createElement("button")).className="auth-btn auth-btn-small hidden",r.id="statsBtn",r.textContent="My Stats",r.addEventListener("click",function(e){e.stopPropagation(),h()}),s.appendChild(r),(r=document.createElement("button")).className="auth-btn auth-btn-small",r.id="achievementsBtn",r.textContent="Achievements",r.addEventListener("click",function(e){e.stopPropagation(),p()}),s.appendChild(r)),console.log("CSS Tower Defense initialized!")}),document.addEventListener("mousemove",function(e){e.clientX,0}),window.addEventListener("blur",function(){Game.getState()===Game.STATES.PLAYING&&(Game.pause(),Display.showMessage("Paused"))}),window.addEventListener("focus",function(){Game.getState()===Game.STATES.PAUSED&&Game.resume()}),document.addEventListener("contextmenu",function(e){e.target.closest(".map")&&e.preventDefault()})})();